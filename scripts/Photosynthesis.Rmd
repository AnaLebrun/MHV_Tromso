---
title: "Photosynthesis"
author: "AnaisLebrun"
date: "2023-04-14"
output: html_document
---

In this document are presented the data from the mesocosm experiment that took place in Tromso in summer 2022. The focus of the experiment was to test the effect of marine heat wave(s) (MHV) on the Arctic benthic community.   
Data analyse includes chla content, quantum yield measurement, C/N, growth rate & photosynthesis rate.    
Depending on the parameter, two or three kelp species were investigated : *Saccharina latissima* (SL), *Alaria esculenta* (AE) and *Laminaria digitata* (LD).    
    
```{r setup, include=FALSE, warning=FALSE}
library(Rcpp)
library(readxl)
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(broom)
library(stargazer)
library(marelac)
library(lubridate)
library(Rcpp)
library(stringr)
library(magick)
library(cowplot)
library(gridExtra)
library(forcats)
library(ggpubr)
library(firatheme)
library(seacarb)
library(tidyverse)
library(rstatix)
library(lme4)
library(ggpubr)
library(emmeans)
```

Let's first look at the temperature :    
- 1) within time for each condition.    
- 2) the delta temperature between the control and each condition.   

```{r treatments design, include=FALSE, warning=FALSE}
temperature <- read_excel("data/temperature.xlsx", 
     col_types = c("date", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric"))

temperature$date<-temperature$...1
temperature<-temperature[,-1]
#temperature<-separate(col=date,c("date","time")," ",data=temperature)

library(dplyr)
library(lubridate)
library(naniar)

hour_temperature<-temperature %>% 
  mutate(date = ymd_hms(date), dt = as_date(date), hr = hour(date)) %>% 
  group_by(dt, hr) %>% 
  filter(date == min(date)) %>% 
  replace_with_na_all(condition = ~.x <= 0)%>% 
  ungroup()

hour_temperature$C0<-rowMeans(hour_temperature[,1:3])
hour_temperature$C1<-rowMeans(hour_temperature[,4:6])
hour_temperature$C2<-rowMeans(hour_temperature[,7:9])
hour_temperature$C3<-rowMeans(hour_temperature[,10:12])

hour_temperature<-hour_temperature[hour_temperature$date<="2022-07-23 12:00:00",]

Temperature_plot<-ggplot(hour_temperature,aes(x=date))+
  geom_point(aes(y=C3),color="#901C21")+geom_line(aes(y=C3),size=3,color="#901C21",alpha=0.4)+
  geom_point(aes(y=C2),color="#FC1D28")+geom_line(aes(y=C2),size=3,color="#FC1D28",alpha=0.4)+
  geom_point(aes(y=C1),color="#E48121")+geom_line(aes(y=C1),size=3,color="#E48121",alpha=0.4)+
  geom_point(aes(y=C0),color="#92c5de")+ geom_line(aes(y=C0),size=3,color="#92c5de",alpha=0.4)+
  theme_fira()+
  scale_x_datetime(minor_breaks = "day",breaks=seq(as.POSIXct("2022-06-30 12:46:11 CET"),as.POSIXct("2022-07-23 12:00:03 CET"), by="48 hours"),date_labels = "%m-%d")+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        axis.text.x = element_text(angle = 60, vjust = 0.5, hjust=0.5),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  labs(x="time",y="Temperature (°C)")

# Median of temp in each treatment
lapply(hour_temperature, median, na.rm = TRUE)
#$C0
#[1] 8.453333

#$C1
#[1] 10.15333

#$C2
#[1] 10.92

#$C3
#[1] 10.7

lapply(hour_temperature, max, na.rm = TRUE)
#$C0
#[1] 10.17667

#$C1
#[1] 11.88667

#$C2
#[1] 12.93333

#$C3
#[1] 13.80333


jpeg(filename = "figures/Temperature_plot.jpeg",width=950, height=650)
Temperature_plot
dev.off()

delta_temperature<-hour_temperature %>% 
  summarise(deltaC1=C1-C0,deltaC2=C2-C0,deltaC3=C3-C0)

delta_temperature$date<-hour_temperature$date
delta_temperature_plot<-ggplot(delta_temperature,aes(x=date))+
  geom_point(aes(y=deltaC3),color="#901C21")+geom_line(aes(y=deltaC3),size=3,color="#901C21",alpha=0.4)+
  geom_point(aes(y=deltaC2),color="#FC1D28")+geom_line(aes(y=deltaC2),size=3,color="#FC1D28",alpha=0.4)+
  geom_point(aes(y=deltaC1),color="#E48121")+geom_line(aes(y=deltaC1),size=3,color="#E48121",alpha=0.4)+
  theme_fira()+
  scale_x_datetime(minor_breaks = "day",breaks=seq(as.POSIXct("2022-06-30 12:46:11 CET"),as.POSIXct("2022-07-23 12:00:03 CET"), by="48 hours"),date_labels = "%m/%d")+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        axis.text.x = element_text(angle = 60, vjust = 0.5, hjust=0.5),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  labs(x="time",y="Delta Temperature (°C)")

jpeg(filename = "figures/delta_temperature_plot.jpeg",width=950, height=650)
delta_temperature_plot
dev.off()
```

- The condition in orange is C1. It exhibits a +1.76°C and will be renamed as "HT" (for High Temperature) for the rest of the analysis.   
- The condition in light red is C2. It exhibits a +1.76°C and 1 MHV of 13 days and will be renamed as "1MHV" (for 1 Marine Heatwave) for the rest of the analysis.   
- The condition in dark red is C3. It exhibits a +1.76°C and 2 MHV of 5 days each and will be renamed as "2MHV" (for 2 Marine Heatwaves) for the rest of the analysis.   

What happened in situ ? Let's look if we had a MHV dirung the experiment.

```{r Heatwave, echo=FALSE, warning=FALSE, message=FALSE, results=FALSE,fig.width=15,fig.height=10}
library(devtools)
packages <- c("devtools", "ggOceanMapsData", "ggOceanMaps")
inst_packages <- packages %in% rownames(installed.packages())
if (any(!inst_packages)) {
  install.packages(packages[!inst_packages],
          repos = c("https://cloud.r-project.org",
                    "https://mikkovihtakari.github.io/drat")
  )
}

coordinates <- data.frame(site_name=c("Havbruksstasjonen","Melhomen","Sommarøy","Kvaløyvågen"),
                          latitude=c(69.87,69.88,69.63,69.85),
                          longitude=c(18.93,18.86,17.97,18.82))
#Heatwave
# The packages we will need
# install.packages("dplyr")
# install.packages("lubridate")
# install.packages("ggplot2")
# install.packages("tidync")
# install.packages("doParallel")
# install.packages("rerddap")
# install.packages("plyr") # Note that this library should never be loaded, only installed

# The packages we will use
library(dplyr) # A staple for modern data management in R
library(lubridate) # Useful functions for dealing with dates
library(ggplot2) # The preferred library for data visualisation
library(tidync) # For easily dealing with NetCDF data
library(rerddap) # For easily downloading subsets of data
library(doParallel) # For parallel processing

# The information for the NOAA OISST data
rerddap::info(datasetid = "ncdcOisst21Agg_LonPM180", url = "https://coastwatch.pfeg.noaa.gov/erddap/")

# Note that there is also a version with lon values from 0 yo 360
rerddap::info(datasetid = "ncdcOisst21Agg", url = "https://coastwatch.pfeg.noaa.gov/erddap/")

# This function downloads and prepares data based on user provided start and end dates
OISST_sub_dl <- function(time_df){
  OISST_dat <- rerddap::griddap(datasetx = "ncdcOisst21Agg_LonPM180",
                                url = "https://coastwatch.pfeg.noaa.gov/erddap/", 
                                time = c(time_df$start, time_df$end), 
                                zlev = c(0, 0),
                                latitude = c(69.5, 70),
                                longitude = c(18.5, 19),
                                fields = "sst")$data %>% 
    dplyr::mutate(time = base::as.Date(stringr::str_remove(time, "T12:00:00Z"))) %>% 
    dplyr::rename(t = time, temp = sst, lon = longitude, lat = latitude) %>% 
    dplyr::select(lon, lat, t, temp) %>% 
    stats::na.omit()
}
dl_years <- data.frame(date_index = 1:5,
                       start = as.Date(c("1982-01-01", "1990-01-01", 
                                         "1998-01-01", "2006-01-01", "2014-01-01")),
                       end = as.Date(c("1989-12-31", "1997-12-31", 
                                       "2005-12-31", "2013-12-31", "2022-12-31")))
# Download all of the data with one nested request
# The time this takes will vary greatly based on connection speed
base::system.time(
  OISST_data <- dl_years %>% 
    dplyr::group_by(date_index) %>% 
    dplyr::group_modify(~OISST_sub_dl(.x)) %>% 
    dplyr::ungroup() %>% 
    dplyr::select(lon, lat, t, temp)
) # 518 seconds, ~100 seconds per batch
OISST_data %>% 
  #dplyr::filter(t == "2019-12-01") %>% 
  ggplot2::ggplot(aes(x = lon, y = lat)) +
  ggplot2::geom_tile(aes(fill = temp)) +
  # ggplot2::borders() + # Activate this line to see the global map
  ggplot2::scale_fill_viridis_c() +
  ggplot2::coord_quickmap(expand = F) +
  ggplot2::labs(x = NULL, y = NULL, fill = "SST (°C)") +
  ggplot2::theme(legend.position = "bottom")
base::saveRDS(OISST_data, file = "~/Desktop/OISST_vignette.Rds")

OISST <- readRDS("~/Desktop/OISST_vignette.Rds")
ts <- ts2clm(OISST, climatologyPeriod = c("1982-01-01", "2022-12-31"))
mhw <- detect_event(ts)
mhw2 <- mhw$climatology %>% 
  slice(1:104807)
mhw_top <- mhw2 %>% 
  slice(103200:103900)

hour_temperature$date<-as.Date(hour_temperature$date)
ggplot()+
  geom_flame(data = mhw_top,aes(x = t,y = temp, y2 = thresh, fill = "all"), show.legend = T) +
  geom_flame(data = mhw_top, aes(x = t,y = temp, y2 = thresh, fill = "top"),  show.legend = T) +
  geom_line(data = mhw_top,aes(x = t,y = temp, colour = "temp")) +
  geom_line(data = mhw_top,aes(x = t,y = thresh, colour = "thresh"), size = 1.0) +
  geom_line(data = mhw_top,aes(x = t,y = seas, colour = "seas"), size = 1.2) +
  #geom_point(hour_temperature,mapping=aes(x=date,y=C3),color="#901C21")+
  geom_line(hour_temperature,mapping=aes(x=date,y=C3),size=3,color="#901C21",alpha=0.4)+
  #geom_point(hour_temperature,mapping=aes(x=date,y=C2),color="#FC1D28")+
  geom_line(hour_temperature,mapping=aes(x=date,y=C2),size=3,color="#FC1D28",alpha=0.4)+
  #geom_point(hour_temperature,mapping=aes(x=date,y=C1),color="#E48121")+
  geom_line(hour_temperature,mapping=aes(x=date,y=C1),size=3,color="#E48121",alpha=0.4)+
  #geom_point(hour_temperature,mapping=aes(x=date,y=C0),color="#92c5de")+
  geom_line(hour_temperature,mapping=aes(x=date,y=C0),size=3,color="#92c5de",alpha=0.4)+
  scale_colour_manual(name = "Line Colour",
                      values = c("temp" = "black", 
                                 "thresh" =  "forestgreen", 
                                 "seas" = "grey80")) +
  scale_fill_manual(name = "Event Colour", 
                    values = c("all" = "salmon", 
                               "top" = "red")) +
  scale_x_date(date_labels = "%b %Y") +
  guides(colour = guide_legend(override.aes = list(fill = NA))) +
  labs(y = expression(paste("Temperature [", degree, "C]")), x = NULL)

  
  
    
    theme_fira()+
  scale_x_datetime(minor_breaks = "day",breaks=seq(as.POSIXct("2022-06-30 12:46:11 CET"),as.POSIXct("2022-07-23 12:00:03 CET"), by="48 hours"),date_labels = "%m-%d")+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        axis.text.x = element_text(angle = 60, vjust = 0.5, hjust=0.5),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  labs(x="time",y="Temperature (°C)")


############
library(heatwaveR)
ts <- ts2clm(sst_WA, climatologyPeriod = c("1982-01-01", "2011-12-31"))
mhw2 <- mhw$climatology %>% 
  slice(10580:10720)
mhw <- detect_event(ts)
mhw_top <- mhw2 %>% 
  slice(5:111)

ggplot(data = mhw2, aes(x = t)) +
  geom_flame(aes(y = temp, y2 = thresh, fill = "all"), show.legend = T) +
  geom_flame(data = mhw_top, aes(y = temp, y2 = thresh, fill = "top"),  show.legend = T) +
  geom_line(aes(y = temp, colour = "temp")) +
  geom_line(aes(y = thresh, colour = "thresh"), size = 1.0) +
  geom_line(aes(y = seas, colour = "seas"), size = 1.2) +
  scale_colour_manual(name = "Line Colour",
                      values = c("temp" = "black", 
                                 "thresh" =  "forestgreen", 
                                 "seas" = "grey80")) +
  scale_fill_manual(name = "Event Colour", 
                    values = c("all" = "salmon", 
                               "top" = "red")) +
  scale_x_date(date_labels = "%b %Y") +
  guides(colour = guide_legend(override.aes = list(fill = NA))) +
  labs(y = expression(paste("Temperature [", degree, "C]")), x = NULL)

MHW <- detect_event(ts)
MHW_cat <- category(MHW, S = TRUE, name = "WA")

event_line(MHW, spread = 1000, start_date = "2000-11-01", end_date = "2019-06-30", category = TRUE)

```

## 1° Chla <br>   
   
Let's look at the chlorophyll a data.   
The measurements were done on fresh tissues sampled at the beginning (T0) and the end (TF) of the experiment on our 3 kelp species (see above).   
   
```{r Chla , echo=FALSE, warning=FALSE, message=FALSE, results=FALSE,fig.width=15,fig.height=10}
Chla <- read_excel("/Users/anaislebrun/Desktop/These/Meso Tromso 2022/MHV_Tromso/data/CHLA-Tromso.xlsx", col_types = c("numeric","text","text","text","text","text",  "text","text","text","text", "text","text", "text", "text","numeric", "numeric", "text", "text"))

# Data manipulation ####
Chla_TF<-Chla[Chla$`sample type`=="TF",]
Chla_T0<-Chla[Chla$`sample type`=="T0",]
Chla<-rbind(Chla_TF,Chla_T0)
rm(Chla_TF,Chla_T0)

# Il y a t'il des outliers ? 
#Le test généralisé ESD (Extrem Studentized Deviation) de Rosner permet la détection simultanée d’un ou plusieurs #outliers et ne nécessite aucun paramétrage.
library(EnvStats)
library(ggpubr)
# the parameter k defines the number of potential outlier in a dataset, the default k value is 3
Chla_Alaria<-Chla[Chla$species=="AE",]

Chla_Alaria_T0<-Chla_Alaria[Chla_Alaria$treatment=="T0",]
rosnerTest(Chla_Alaria_T0$`Chla (µg.g)`, k = 1)$all.stats # 1 outlier : 271.7544
Chla_Alaria_T0<-Chla_Alaria_T0[!Chla_Alaria_T0$ID=="bis",]
shapiro.test(Chla_Alaria_T0$`Chla (µg.g)`) # Normal (pvalue>0.05)
ggqqplot(Chla_Alaria_T0$`Chla (µg.g)`)

Chla_Alaria_C0<-Chla_Alaria[Chla_Alaria$treatment=="C0",]
rosnerTest(Chla_Alaria_C0$`Chla (µg.g)`, k = 1)$all.stats # 420.93720 is an outlier
Chla_Alaria_C0<-Chla_Alaria_C0[!Chla_Alaria_C0$`Chla (µg.g)`>=400,]
shapiro.test(Chla_Alaria_C0$`Chla (µg.g)`) # OK Normal now
ggqqplot(Chla_Alaria_C0$`Chla (µg.g)`)

Chla_Alaria_C1<-Chla_Alaria[Chla_Alaria$treatment=="C1",]
rosnerTest(Chla_Alaria_C1$`Chla (µg.g)`, k = 1)$all.stats # no outlier
shapiro.test(Chla_Alaria_C1$`Chla (µg.g)`)  # OK Normal

Chla_Alaria_C2<-Chla_Alaria[Chla_Alaria$treatment=="C2",]
rosnerTest(Chla_Alaria_C2$`Chla (µg.g)`, k = 1)$all.stats # no outlier
shapiro.test(Chla_Alaria_C2$`Chla (µg.g)`) # OK Normal 
ggqqplot(Chla_Alaria_C2$`Chla (µg.g)`)

Chla_Alaria_C3<-Chla_Alaria[Chla_Alaria$treatment=="C3",]
rosnerTest(Chla_Alaria_C3$`Chla (µg.g)`, k = 1)$all.stats # no outlier
shapiro.test(Chla_Alaria_C3$`Chla (µg.g)`) # OK Normal
ggqqplot(Chla_Alaria_C3$`Chla (µg.g)`)

# Rbind
Chla_Alaria<-rbind(Chla_Alaria_T0,Chla_Alaria_C0,Chla_Alaria_C1,Chla_Alaria_C2,Chla_Alaria_C3)
rm(Chla_Alaria_T0,Chla_Alaria_C0,Chla_Alaria_C1,Chla_Alaria_C2,Chla_Alaria_C3)

# Saccharina
Chla_Saccharina<-Chla[Chla$species=="SL",]
Chla_Saccharina_T0<-Chla_Saccharina[Chla_Saccharina$treatment=="T0",]
rosnerTest(Chla_Saccharina_T0$`Chla (µg.g)`, k = 1)$all.stats  # no outlier
shapiro.test(Chla_Saccharina_T0$`Chla (µg.g)`) # Normal
ggqqplot(Chla_Saccharina_T0$`Chla (µg.g)`)

Chla_Saccharina_C0<-Chla_Saccharina[Chla_Saccharina$treatment=="C0",]
rosnerTest(Chla_Saccharina_C0$`Chla (µg.g)`, k = 1)$all.stats  # no outlier
shapiro.test(Chla_Saccharina_C0$`Chla (µg.g)`) #Normal

Chla_Saccharina_C1<-Chla_Saccharina[Chla_Saccharina$treatment=="C1",]
rosnerTest(Chla_Saccharina_C1$`Chla (µg.g)`, k = 3)$all.stats #   no outlier
shapiro.test(Chla_Saccharina_C1$`Chla (µg.g)`) #Normal
ggqqplot(Chla_Saccharina_C1$`Chla (µg.g)`)

Chla_Saccharina_C2<-Chla_Saccharina[Chla_Saccharina$treatment=="C2",]
rosnerTest(Chla_Saccharina_C2$`Chla (µg.g)`, k = 1)$all.stats  # no outlier
shapiro.test(Chla_Saccharina_C2$`Chla (µg.g)`) # OK Normal now
ggqqplot(Chla_Saccharina_C2$`Chla (µg.g)`)

Chla_Saccharina_C3<-Chla_Saccharina[Chla_Saccharina$treatment=="C3",]
rosnerTest(Chla_Saccharina_C3$`Chla (µg.g)`, k = 1)$all.stats  # 104.50361 is an outlier
Chla_Saccharina_C3<-Chla_Saccharina_C3[!Chla_Saccharina_C3$`Chla (µg.g)`>=100,]
shapiro.test(Chla_Saccharina_C3$`Chla (µg.g)`) # OK Normal now
ggqqplot(Chla_Saccharina_C3$`Chla (µg.g)`)

# Rbind
Chla_Saccharina<-rbind(Chla_Saccharina_T0,Chla_Saccharina_C0,Chla_Saccharina_C1,Chla_Saccharina_C2,Chla_Saccharina_C3)
rm(Chla_Saccharina_T0,Chla_Saccharina_C0,Chla_Saccharina_C1,Chla_Saccharina_C2,Chla_Saccharina_C3)

# Laminaria
Chla_Laminaria<-Chla[Chla$species=="LD",]

Chla_Laminaria_T0<-Chla_Laminaria[Chla_Laminaria$treatment=="T0",]
rosnerTest(Chla_Laminaria_T0$`Chla (µg.g)`, k = 1)$all.stats  # no outlier
shapiro.test(Chla_Laminaria_T0$`Chla (µg.g)`) # Normal
ggqqplot(Chla_Laminaria_T0$`Chla (µg.g)`)

Chla_Laminaria_C0<-Chla_Laminaria[Chla_Laminaria$treatment=="C0",]
rosnerTest(Chla_Laminaria_C0$`Chla (µg.g)`, k = 1)$all.stats  # no outlier
shapiro.test(Chla_Laminaria_C0$`Chla (µg.g)`) # OK Normal
ggqqplot(Chla_Laminaria_C0$`Chla (µg.g)`)

Chla_Laminaria_C1<-Chla_Laminaria[Chla_Laminaria$treatment=="C1",]
rosnerTest(Chla_Laminaria_C1$`Chla (µg.g)`, k = 1)$all.stats # no outlier
shapiro.test(Chla_Laminaria_C1$`Chla (µg.g)`) # not Normal
ggqqplot(Chla_Laminaria_C1$`Chla (µg.g)`)

Chla_Laminaria_C2<-Chla_Laminaria[Chla_Laminaria$treatment=="C2",]
rosnerTest(Chla_Laminaria_C2$`Chla (µg.g)`, k = 1)$all.stats # no outlier
shapiro.test(Chla_Laminaria_C2$`Chla (µg.g)`) # OK Normal
ggqqplot(Chla_Laminaria_C2$`Chla (µg.g)`)

Chla_Laminaria_C3<-Chla_Laminaria[Chla_Laminaria$treatment=="C3",]
rosnerTest(Chla_Laminaria_C3$`Chla (µg.g)`, k = 1)$all.stats # no outlier
shapiro.test(Chla_Laminaria_C3$`Chla (µg.g)`) # OK Normal
ggqqplot(Chla_Laminaria_C3$`Chla (µg.g)`)
# no outlier with Laminaria

rm(Chla_Laminaria_T0,Chla_Laminaria_C0,Chla_Laminaria_C1,Chla_Laminaria_C2,Chla_Laminaria_C3)

Chla<-rbind(Chla_Saccharina,Chla_Laminaria,Chla_Alaria)
rm(Chla_Saccharina,Chla_Laminaria,Chla_Alaria)
give.n <- function(x){
   return(c(y = mean(x), label = length(x)))
}

# PLOTS 
# Define the order of apparition of the condition (x axis)
Chla$treatment_renamed <- "C"
Chla$treatment_renamed[Chla$treatment=="T0"] <- "T0"
Chla$treatment_renamed[Chla$treatment=="C1"] <- "HT"
Chla$treatment_renamed[Chla$treatment=="C2"] <- "1MH"
Chla$treatment_renamed[Chla$treatment=="C3"] <- "2MH"


Chla$treatment_renamed <- fct_relevel(Chla$treatment_renamed, c("T0", "C","HT","1MH","2MH"))

Chla_plot_no_outlier<-ggplot(Chla,aes(y=`Chla (µg.g)`,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  theme_fira()+
  geom_jitter(shape = 21,aes(fill=treatment_renamed),color="black",size=3)+
  facet_wrap(~species,scales='free')+
  scale_fill_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  scale_color_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0),colour="black",data=Chla,fun.data = give.n, geom = "text",size=8)+
  theme(axis.title = element_text(size = rel(1.5), face = "bold", hjust=0.5),
        axis.text = element_text(size = rel(1.5)),
        strip.text.x = element_text(size = rel(1.5),face="bold"),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  ylab(bquote('Chl a '(µg.FW^-1)))+
  xlab(bquote('conditions'))+
  scale_y_continuous(limits = c(0, 110))

jpeg(filename = "figures/Chla/Chla_plot_no_outlier.jpeg",width=950, height=650)
Chla_plot_no_outlier
dev.off()

Pheo_plot_no_outlier<-ggplot(Chla,aes(y=`Pheo (µg.g)`,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  theme_fira()+
  geom_jitter(shape = 21,aes(fill=treatment_renamed),color="black",size=3)+
  facet_wrap(~species,scales='free')+
  scale_fill_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  scale_color_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0),colour="black",data=Chla,fun.data = give.n, geom = "text",size=8)+
  theme(axis.title = element_text(size = rel(1.5), face = "bold", hjust=0.5),
        axis.text = element_text(size = rel(1.5)),
        strip.text.x = element_text(size = rel(1.5),face="bold"),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  ylab(bquote('Pheopigments '(µg.FW^-1)))+
  xlab(bquote('conditions'))+
  scale_y_continuous(limits = c(0, 290))

jpeg(filename = "figures/Chla/Pheo_plot_no_outlier.jpeg",width=950, height=650)
Pheo_plot_no_outlier
dev.off()

jpeg(filename = "figures/Chla/Chla_Pheo_plots_no_outlier.jpeg",width=950, height=1300)
ggarrange(Chla_plot_no_outlier,Pheo_plot_no_outlier,
          ncol = 1, nrow = 2,common.legend = TRUE)
dev.off()
# Statistics ####
Anova_Chla<-aov(`Chla (µg.g)` ~ treatment*species, data = Chla)
TukeyHSD(Anova_Chla)
# p-value < 0.05 :
# All species combined: 
#           diff        lwr        upr     p adj
#2MHV-T0 -35.0535233 -53.26311 -16.8439369 0.0000069 
#C3-C1 -24.1152426 -44.27651  -3.9539704 0.0108818

#AE:
#                   diff        lwr        upr     p adj
#2MH:AE-T0:AE -49.34868666 -87.938717 -10.7586568 0.0021466
#2MH:AE-1MH:AE -34.37548857 -77.520454   8.7694764 0.2754528


#SL
#                   diff        lwr        upr     p adj
#C3:SL-T0:SL -49.72725072 -90.658158  -8.7963430 0.0047080

#LD : no significative difference

############ HERE ############
# Is there a link between Chl a content & the age of the algae ? Size of an individual is a proxy of its age. Let's see if we find a link between Chla & frond lenght.
library(nlme)
library(ggu.base.fun)
# log transformation is necessary to look into a LINEAR model here
# It allows the residuals to be normaly distributed (see later)
#Growth_normalized$lg_growth_rate<-log(Growth_normalized$Growth_rate)
#Growth_normalized$lg_total_lenght<-log(Growth_normalized$`Total lenght (cm)`)

Kelp_ID <- read_excel("data/Kelp_ID.xlsx", 
     col_types = c("numeric", "text", "numeric", 
         "text", "text", "numeric", "numeric", 
         "numeric", "text", "text", "text"))
Chla_normalized<-merge(Kelp_ID,Chla,by="ID")
Chla_normalized <- Chla_normalized %>%
  rename(total_lenght = `Total lenght (cm)`,
         Chla=`Chla (µg.g)`)

Chla_normalized <- Chla_normalized[!is.infinite(Chla_normalized$total_lenght),]
Chla_normalized <- Chla_normalized[!is.na(Chla_normalized$total_lenght),] 
Chla_normalized <- Chla_normalized[!is.infinite(Chla_normalized$Chla),]#remove inf values
Chla_normalized <- Chla_normalized[!is.na(Chla_normalized$Chla),] # remove NA 
########### HERE ############
#Chla_normalized$log_chla<-log(Chla_normalized$`Chla (µg.g)`)
#Chla_normalized$log_total_lenght<-log(Chla_normalized$total_lenght)

boxcox <- boxCox(na.omit(Chla_normalized$Chla) ~ na.omit(Chla_normalized$total_lenght), lambda = seq(-5,5,0.1))
lambda <- boxcox$x[which.max(boxcox$y)]
Chla_normalized$chla_bc <- if (lambda != 0) {
  (Chla_normalized$Chla^lambda - 1) / lambda
} else {
  log(Chla_normalized$Chla)
}

is.numeric(Chla_normalized$chla_bc)

length_lm <- lm(log(Chla_normalized$chla_bc) ~ log(Chla_normalized$total_lenght), data=Chla_normalized)
plot(log(Chla_normalized$chla_bc) ~ log(Chla_normalized$total_lenght), data=Chla_normalized)
abline(length_lm)
summary(length_lm)
legend("topleft", legend=paste("R2 is", format(summary(length_lm)$r.squared,digits=3)))

Chla_normalized$Normalized_Chla <- if (lambda != 0) {
  (Chla_normalized$chla_bc * lambda + 1)^(1/lambda)
} else {
  exp(Chla_normalized$chla_bc)
}


Normalized_Chla_plot_no_outlier<-ggplot(Chla_normalized,aes(y=Normalized_Chla,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  theme_fira()+
  geom_jitter(shape = 21,aes(fill=treatment_renamed),color="black",size=3)+
  facet_wrap(~species,scales='free')+
  scale_fill_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  scale_color_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0),colour="black",data=Chla_normalized,fun.data = give.n, geom = "text",size=8)+
  theme(axis.title = element_text(size = rel(1.5), face = "bold", hjust=0.5),
        axis.text = element_text(size = rel(1.5)),
        strip.text.x = element_text(size = rel(1.5),face="bold"),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  ylab(bquote('Chl a '(µg.FW^-1)))+
  xlab(bquote('conditions'))

length_lm <- lm(log_chla ~ log_total_lenght,data=Chla_normalized)
plot(log_chla ~ log_total_lenght,data=Chla_normalized)
abline(length_lm)
summary(length_lm)
legend("topleft",legend=paste("R2 is", format(summary(length_lm)$r.squared,digits=3)))
# equation : log(y)=7.4271- 0.8496*log(total_lenght) + 0.5981
Chla_normalized$Normalized_Chla<-10^(7.4271-0.8496*Chla_normalized$log_total_lenght+0.5981)

# normality of standardized model residuals
length_lm_std <- residuals(length_lm, type="pearson")
shapiro.test(length_lm_std) #p-value = 0.6689, normality verified
qqnorm(length_lm_std)
qqline(length_lm_std)
hist(length_lm_std, xlab="standardized residuals")

library(car)
# homogeneity of model variances
leveneTest(length_lm_std , group = Chla_normalized$log_chla) # NaN
leveneTest(length_lm_std , group = Chla_normalized$log_total_lenght) # Homogeneity verified

Normalized_Chla_plot_no_outlier<-ggplot(Chla_normalized,aes(y=Normalized_Chla,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  theme_fira()+
  geom_jitter(shape = 21,aes(fill=treatment_renamed),color="black",size=3)+
  facet_wrap(~species,scales='free')+
  scale_fill_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  scale_color_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0),colour="black",data=Chla_normalized,fun.data = give.n, geom = "text",size=8)+
  theme(axis.title = element_text(size = rel(1.5), face = "bold", hjust=0.5),
        axis.text = element_text(size = rel(1.5)),
        strip.text.x = element_text(size = rel(1.5),face="bold"),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  ylab(bquote('Chl a '(µg.FW^-1)))+
  xlab(bquote('conditions'))#+
  #scale_y_continuous(limits = c(0, 110))

### ANOVA for the final model
anova(length_lm)
#Analysis of Variance Table
#Response: lg_growth_rate
#                 Df  Sum Sq Mean Sq F value    Pr(>F)    
#lg_total_lenght   1  32.777  32.777  31.274 1.081e-07 ***
#Residuals       145 151.971   1.048                      
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.

```

Here are the data obtained after removing outliers using the Rosner test.   
For both AE and SL, a significant decrease in tissue chlorophyll content was observed between T0 and 2MH.   
Although the difference with the control was not significant, these observations suggest a decrease in chlorophyll content that could be due to both treatment and the life cycle of these two kelps.   
Therefore, repeated strong MHV could accelerate the decline in chlorophyll content in these two species during the summer period, which could directly impact their photosynthetic capacity. We may be able to see this with the incubation data.  
    
## 2° C/N <br>

```{r C/N, echo=FALSE, warning=FALSE, message=FALSE, results=FALSE,fig.width=15,fig.height=10}
CHN <- read_excel("data/CHN-TROMSO.xlsx", 
     col_types = c("text", "text", "text", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric"))

CHN<-inner_join(CHN, Chla, by=c("ID","species"))

# Search for outliers in C/N :
# AE:
CHN_AE<-CHN[CHN$species=="AE",]
CHN_AE_C0<-CHN_AE[CHN_AE$treatment=="C0",]
rosnerTest(CHN_AE_C0$`C/N`, k = 1)$all.stats # 10.78064 is an outlier
CHN_AE_C0<-CHN_AE_C0[!CHN_AE_C0$ID=="12",]
shapiro.test(CHN_AE_C0$`C/N`) # Normal

CHN<-CHN[!CHN$ID=="12",]

#LD
CHN_LD<-CHN[CHN$species=="LD",]
CHN_LD_C3<-CHN_LD[CHN_LD$treatment=="C3",]
rosnerTest(CHN_LD_C3$`C/N`, k = 2)$all.stats # 0.1632123 & 3.9744147 are outliers, they both correspond to ID 141
CHN_LD_C3<-CHN_LD_C3[!CHN_LD_C3$ID=="141",]
shapiro.test(CHN_LD_C3$`C/N`) # Normal

CHN<-CHN[!CHN$ID=="141",]

# Search for outliers in C & N separated :
# Let's start with C
# AE
# C0
rosnerTest(CHN_AE_C0$C_1mg, k = 1)$all.stats #64.51351 is an outlier
CHN_AE_C0<-CHN_AE_C0[!CHN_AE_C0$ID=="1",]
shapiro.test(CHN_AE_C0$C_1mg) # Normal

CHN<-CHN[!CHN$ID=="1",]

#C3
CHN_AE_C3<-CHN_AE[CHN_AE$treatment=="C3",]
rosnerTest(CHN_AE_C3$C_1mg, k = 1)$all.stats #  217.3729 is an outlier
CHN_AE_C3<-CHN_AE_C3[!CHN_AE_C3$ID=="54",]
shapiro.test(CHN_AE_C3$C_1mg) # Normal

CHN<-CHN[!CHN$ID=="54",]

# LD
CHN_LD_C2<-CHN_LD[CHN_LD$treatment=="C2",]
rosnerTest(CHN_LD_C2$C_1mg, k = 1)$all.stats #  no outlier
shapiro.test(CHN_LD_C2$C_1mg) # Normal
 
# SL
# T0
CHN_SL<-CHN[CHN$species=="SL",]
CHN_SL_T0<-CHN_SL[CHN_SL$treatment=="T0",]
rosnerTest(CHN_SL_T0$C_1mg, k = 1)$all.stats # 443.8972 is an outlier
CHN_SL_T0<-CHN_SL_T0[!CHN_SL_T0$ID=="T0 5",]
shapiro.test(CHN_SL_T0$C_1mg) #Normal

CHN<-CHN[!CHN$Samples.x=="SLT0 5",]

# C0
CHN_SL_C0<-CHN_SL[CHN_SL$treatment=="C0",]
rosnerTest(CHN_SL_C0$C_1mg, k = 1)$all.stats # 3662.235 is an outlier
CHN_SL_C0<-CHN_SL_C0[!CHN_SL_C0$ID=="109",]
shapiro.test(CHN_SL_C0$C_1mg) #Normal

CHN<-CHN[!CHN$ID=="109",]

# C2
CHN_SL_C2<-CHN_SL[CHN_SL$treatment=="C2",]
rosnerTest(CHN_SL_C2$C_1mg, k = 1)$all.stats # no outlier
shapiro.test(CHN_SL_C2$C_1mg) #Normal

# What about N ? 
# AE C2
CHN_AE_C2<-CHN_AE[CHN_AE$treatment=="C2",]
rosnerTest(CHN_AE_C2$N_1mg, k = 1)$all.stats # no outlier
shapiro.test(CHN_AE_C2$C_1mg) # Normal

# SL C0
rosnerTest(CHN_SL_C0$N_1mg, k = 1)$all.stats # no outlier

rm(CHN_AE,CHN_AE_C0,CHN_AE_C2,CHN_AE_C3,CHN_LD,CHN_LD_C2,CHN_LD_C3,CHN_SL,CHN_SL_C0,CHN_SL_C2,CHN_SL_T0)

give.n <- function(x){
   return(c(y = mean(x), label = length(x)))
}
  
CHN$treatment_renamed <- fct_relevel(CHN$treatment_renamed, c("T0", "C","HT","1MH","2MH"))

#boxplot C/N
CN_no_outlier<-ggplot(CHN,aes(y=`C/N`,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(shape = 21,aes(fill=treatment_renamed),color="black",size=3)+
  facet_wrap(~species)+
  scale_fill_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=10,x=treatment_renamed),colour="black",data=CHN,fun.data = give.n, geom = "text",size=10)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  ylab(bquote("C/N"))+
  xlab(bquote('conditions'))

jpeg(filename = "figures/CN/CN.jpeg",width=950, height=650)
CN_no_outlier
dev.off()

#boxplot C
C_no_outlier<-ggplot(CHN,aes(y=C_1mg,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(shape = 21,aes(fill=treatment_renamed),color="black",size=3)+
  facet_wrap(~species)+
  scale_fill_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  ylab(bquote('C'(mg.g^-1,DW)))+
  xlab(bquote('conditions'))

jpeg(filename = "figures/CN/C_no_outlier.jpeg",width=950, height=650)
C_no_outlier
dev.off()
#boxplot N
N_no_outlier<-ggplot(CHN,aes(y=N_1mg,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(shape = 21,aes(fill=treatment_renamed),color="black",size=3)+
  facet_wrap(~species)+
  scale_fill_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  ylab(bquote('N'(mg.g^-1,DW)))+
  xlab(bquote('conditions'))
jpeg(filename = "figures/CN/N.jpeg",width=950, height=650)
N_no_outlier
dev.off()

jpeg(filename = "figures/CN/CN_C_N_no_outlier.jpeg",width=950, height=1300)
ggarrange(CN_no_outlier,C_no_outlier,N_no_outlier,
          ncol = 1, nrow = 3,common.legend = TRUE)
dev.off()
# Statistics C/N
Anova_CN<-aov(`C/N` ~ treatment*species, data = CHN)
TukeyHSD(Anova_CN)
# No significative difference between treatments within each species
# interesting :
#                  diff        lwr        upr     p adj
#C3:AE-C2:AE  6.13485741  -0.3752215 12.64493636 0.0842364 
Anova_C<-aov(C_1mg ~ treatment*species, data = CHN)
TukeyHSD(Anova_C)
# No significative difference between treatments within each species
# interesting :
#                  diff        lwr        upr     p adj
#C3:AE-C1:AE   67.6917804   -3.246368 138.629929 0.0758831
Anova_N<-aov(N_1mg ~ treatment*species, data = CHN)
TukeyHSD(Anova_N)
# No significative difference between treatments within each species

```
There was no significant difference observed in the C/N ratio, as well as the C and N content, between the conditions for any of the three species.

## 3° Diving PAM <br>
```{r PAM, echo=FALSE, warning=FALSE, message=FALSE, results=FALSE,fig.width=15,fig.height=10}
#### KELP ####
Kelp_Pam <- read_excel("data/Kelp_Pam.xlsx", col_types = c("date", 
     "text", "text", "text", "text", "text", 
     "numeric", "numeric", "numeric", "numeric", 
     "numeric", "numeric", "text"))
give.n <- function(x){
   return(c(y = mean(x), label = length(x)))
}

Kelp_Pam$treatment_renamed <- "C"
Kelp_Pam$treatment_renamed[Kelp_Pam$treatment=="C1"] <- "HT"
Kelp_Pam$treatment_renamed[Kelp_Pam$treatment=="C2"] <- "1MH"
Kelp_Pam$treatment_renamed[Kelp_Pam$treatment=="C3"] <- "2MH"
Kelp_Pam$treatment_renamed[Kelp_Pam$Sampling=="T0"]<-"T0"

Kelp_Pam$treatment_renamed <- fct_relevel(Kelp_Pam$treatment_renamed, c("T0","C","HT","1MH","2MH"))

# All period merged
ggplot(Kelp_Pam,aes(y=`Fv/Fm`,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(shape = 21,color="black",size=3)+
  facet_wrap(~species)+
  scale_fill_manual(values=c("lightgrey","#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.4,x=treatment_renamed),colour="black",data=Kelp_Pam,fun.data = give.n, geom = "text",size=10)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
   ylab(bquote(F[v]/F[m]))+
  labs(x="conditions")

Kelp_Pam$group<-paste0(Kelp_Pam$treatment_renamed,Kelp_Pam$Date,sep="_")
Kelp_Pam$Date<-as.POSIXct(Kelp_Pam$Date,format="%Y-%M-%D")

ggplot(Kelp_Pam,aes(y=`Fv/Fm`,x=Date,color=treatment_renamed))+
  geom_jitter(shape = 16,size=3,alpha=0.8)+
  #geom_smooth(se=F,size=2,alpha=0.5)+
  geom_boxplot(aes(x=Date,group=group,fill=treatment_renamed),color="black",outlier.alpha = 0)+
  facet_wrap(species~.,ncol=1)+
  scale_fill_manual(values=c("lightgrey","#92c5de","#E48121","#FC1D28","#901C21"))+
  scale_color_manual(values=c("lightgrey","#92c5de","#E48121","#FC1D28","#901C21"))+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
   ylab(bquote(F[v]/F[m]))+
  #scale_x_continuous(breaks=c("2022-07-02 UTC","2022-07-07 UTC","2022-07-11 UTC","2022-07-14 UTC","2022-07-18 UTC","2022-07-21 UTC","2022-07-22 UTC")+
  labs(x="conditions")


# to do :
# changer les stick x : mettre 1 axe par date (donc 7 tick)
# ploter la température (sur un autre graph ? ou par dessus ?)

# Is there outlier ? 
library(EnvStats)
library(ggpubr)
# ALARIA ####
AE_PAM<-Kelp_Pam[Kelp_Pam$species=="Alaria",]

AE_PAM_T0<-AE_PAM[AE_PAM$treatment_renamed=="T0",]
#AE_PAM_C0_day1<-AE_PAM_C0[AE_PAM_C0$Sampling=="exp_day1",]
rosnerTest(AE_PAM_T0$`Fv/Fm`, k = 2)$all.stats # no outlier
shapiro.test(AE_PAM_T0$`Fv/Fm`) # almost normal : p-value = 0.01946
ggqqplot(AE_PAM_T0$`Fv/Fm`)

AE_PAM_C0<-AE_PAM[AE_PAM$treatment_renamed=="C",]
rosnerTest(AE_PAM_C0$`Fv/Fm`, k = 1)$all.stats # no outlier
shapiro.test(AE_PAM_C0$`Fv/Fm`) # Normal (pvalue>0.05)
ggqqplot(AE_PAM_C0$`Fv/Fm`)

AE_PAM_C1<-AE_PAM[AE_PAM$treatment_renamed=="1MH",]
ggqqplot(AE_PAM_C1$`Fv/Fm`) 
rosnerTest(AE_PAM_C1$`Fv/Fm`, k = 2)$all.stats #0.647 is an outlier
AE_PAM_C1<-AE_PAM_C1[!AE_PAM_C1$`Fv/Fm`==0.623,]
AE_PAM_C1<-AE_PAM_C1[!AE_PAM_C1$`Fv/Fm`==0.390,]

AE_PAM_C2<-AE_PAM[AE_PAM$treatment_renamed=="HT",]
rosnerTest(AE_PAM_C2$`Fv/Fm`, k = 2)$all.stats # no outlier 
shapiro.test(AE_PAM_C2$`Fv/Fm`) # Normal
ggqqplot(AE_PAM_C2$`Fv/Fm`) 

AE_PAM_C3<-AE_PAM[AE_PAM$treatment_renamed=="2MH",]
ggqqplot(AE_PAM_C3$`Fv/Fm`) 
shapiro.test(AE_PAM_C3$`Fv/Fm`) # Normal
rosnerTest(AE_PAM_C3$`Fv/Fm`, k = 1)$all.stats #no outlier

# Rbind
AE_PAM<-rbind(AE_PAM_T0,AE_PAM_C0,AE_PAM_C1,AE_PAM_C2,AE_PAM_C3)
rm(AE_PAM_T0,AE_PAM_C0,AE_PAM_C1,AE_PAM_C2,AE_PAM_C3)

# LAMINARIA ####
LD_PAM<-Kelp_Pam[Kelp_Pam$species=="Laminaria",]

LD_PAM_T0<-LD_PAM[LD_PAM$treatment_renamed=="T0",]
ggqqplot(LD_PAM_T0$`Fv/Fm`)
rosnerTest(LD_PAM_T0$`Fv/Fm`, k = 1)$all.stats # no outlier
shapiro.test(LD_PAM_T0$`Fv/Fm`) # Normal

LD_PAM_C0<-LD_PAM[LD_PAM$treatment_renamed=="C",]
ggqqplot(LD_PAM_C0$`Fv/Fm`)
rosnerTest(LD_PAM_C0$`Fv/Fm`, k = 2)$all.stats # 2 outliers:  0.473 & 0.478
LD_PAM_C0<-LD_PAM_C0[!LD_PAM_C0$`Fv/Fm`==0.473,]
LD_PAM_C0<-LD_PAM_C0[!LD_PAM_C0$`Fv/Fm`==0.478,]
shapiro.test(LD_PAM_C0$`Fv/Fm`) # Normal (pvalue>0.05)
ggqqplot(LD_PAM_C0$`Fv/Fm`)

LD_PAM_C1<-LD_PAM[LD_PAM$treatment_renamed=="HT",]
rosnerTest(LD_PAM_C1$`Fv/Fm`, k = 1)$all.stats # 1 outlier : 0.528
LD_PAM_C1<-LD_PAM_C1[!LD_PAM_C1$`Fv/Fm`==0.528,]
shapiro.test(LD_PAM_C1$`Fv/Fm`) # Almost Normal
ggqqplot(LD_PAM_C1$`Fv/Fm`)

LD_PAM_C2<-LD_PAM[LD_PAM$treatment_renamed=="1MH",]
rosnerTest(LD_PAM_C2$`Fv/Fm`, k = 2)$all.stats # 2 outliers : 0.523 & 0.577
LD_PAM_C2<-LD_PAM_C2[!LD_PAM_C2$`Fv/Fm`==0.523,]
LD_PAM_C2<-LD_PAM_C2[!LD_PAM_C2$`Fv/Fm`==0.577,]
shapiro.test(LD_PAM_C2$`Fv/Fm`) # Normal (pvalue>0.05)
ggqqplot(LD_PAM_C2$`Fv/Fm`)

LD_PAM_C3<-LD_PAM[LD_PAM$treatment_renamed=="2MH",]
rosnerTest(LD_PAM_C3$`Fv/Fm`, k = 1)$all.stats # 1 outlier : 0.409
LD_PAM_C3<-LD_PAM_C3[!LD_PAM_C3$`Fv/Fm`==0.409,]
shapiro.test(LD_PAM_C3$`Fv/Fm`) # Almost normal
ggqqplot(LD_PAM_C3$`Fv/Fm`)

LD_PAM<-rbind(LD_PAM_T0,LD_PAM_C0,LD_PAM_C1,LD_PAM_C2,LD_PAM_C3)
rm(LD_PAM_T0,LD_PAM_C0,LD_PAM_C1,LD_PAM_C2,LD_PAM_C3)

# SACCHARINA ####

SL_PAM<-Kelp_Pam[Kelp_Pam$species=="Saccharina",]

SL_PAM_T0<-SL_PAM[SL_PAM$treatment_renamed=="T0",]
ggqqplot(SL_PAM_T0$`Fv/Fm`)
rosnerTest(SL_PAM_T0$`Fv/Fm`, k = 1)$all.stats # no outlier
shapiro.test(SL_PAM_T0$`Fv/Fm`) # NORMAL

SL_PAM_C<-SL_PAM[SL_PAM$treatment_renamed=="C",]
ggqqplot(SL_PAM_C$`Fv/Fm`)
rosnerTest(SL_PAM_C$`Fv/Fm`, k = 3)$all.stats # 1 outlier
SL_PAM<-SL_PAM[!SL_PAM$`Fv/Fm`==0.869,]
shapiro.test(SL_PAM_C$`Fv/Fm`) # Normal (pvalue>0.05)

SL_PAM_C1<-SL_PAM[SL_PAM$treatment_renamed=="HT",]
ggqqplot(SL_PAM_C1$`Fv/Fm`)
rosnerTest(SL_PAM_C1$`Fv/Fm`, k = 1)$all.stats # no outlier
shapiro.test(SL_PAM_C1$`Fv/Fm`) # Normal (pvalue>0.05)

SL_PAM_C2<-SL_PAM[SL_PAM$treatment_renamed=="1MH",]
ggqqplot(SL_PAM_C2$`Fv/Fm`)
rosnerTest(SL_PAM_C2$`Fv/Fm`, k = 1)$all.stats # no outlier
shapiro.test(SL_PAM_C2$`Fv/Fm`)# Normal (pvalue>0.05)

SL_PAM_C3<-SL_PAM[SL_PAM$treatment_renamed=="2MH",]
ggqqplot(SL_PAM_C3$`Fv/Fm`)
rosnerTest(SL_PAM_C3$`Fv/Fm`, k = 1)$all.stats # no outlier
shapiro.test(SL_PAM_C3$`Fv/Fm`)# Normal (pvalue>0.05)

SL_PAM<-rbind(SL_PAM_T0,SL_PAM_C,SL_PAM_C1,SL_PAM_C2,SL_PAM_C3)
rm(SL_PAM_T0,SL_PAM_C,SL_PAM_C1,SL_PAM_C2,SL_PAM_C3,SL_PAM_C1)

Kelp_PAM_no_outlier<-rbind(AE_PAM,LD_PAM,SL_PAM)
rm(AE_PAM,LD_PAM,SL_PAM)

Kelp_PAM_no_outlier$species_modified<-"AE"
Kelp_PAM_no_outlier$species_modified[Kelp_PAM_no_outlier$species=="Laminaria"]<-"LD"
Kelp_PAM_no_outlier$species_modified[Kelp_PAM_no_outlier$species=="Saccharina"]<-"SL"
Kelp_PAM_no_outlier<-Kelp_PAM_no_outlier[!is.na(Kelp_PAM_no_outlier$species)=="TRUE",]

# PLOTs without the outliers: 
Kelp_Pam_plot_no_outlier<-ggplot(Kelp_PAM_no_outlier,aes(y=`Fv/Fm`,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(shape = 21,color="black",size=3)+
  facet_wrap(~species_modified)+
  scale_fill_manual(values=c("lightgrey","#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.4,x=treatment_renamed),colour="black",data=Kelp_PAM_no_outlier,fun.data = give.n, geom = "text",size=10)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
   ylab(bquote(F[v]/F[m]))+
  labs(x="conditions")

jpeg(filename = "figures/PAM/Kelp_Pam_alperiod_plot_no_outlier.jpeg",width=950, height=650)
Kelp_Pam_plot_no_outlier
dev.off()

Kelp_PAM_no_outlier$date_modified<-0

Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day1"&Kelp_PAM_no_outlier$treatment_renamed=="C"]<-2.125/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day1"&Kelp_PAM_no_outlier$treatment_renamed=="HT"]<-2.375/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day1"&Kelp_PAM_no_outlier$treatment_renamed=="1MH"]<-2.625/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day1"&Kelp_PAM_no_outlier$treatment_renamed=="2MH"]<-2.875/2

Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day2"&Kelp_PAM_no_outlier$treatment_renamed=="C"]<-4.25/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day2"&Kelp_PAM_no_outlier$treatment_renamed=="1MH"]<-4.5/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day2"&Kelp_PAM_no_outlier$treatment_renamed=="2MH"]<-4.75/2


Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day3"&Kelp_PAM_no_outlier$treatment_renamed=="HT"]<-5.875/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day3"&Kelp_PAM_no_outlier$treatment_renamed=="2MH"]<-6.125/2

Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day4"&Kelp_PAM_no_outlier$treatment_renamed=="1MH"]<-7.875/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="exp_day4"&Kelp_PAM_no_outlier$treatment_renamed=="2MH"]<-8.125/2

Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="TF"&Kelp_PAM_no_outlier$treatment_renamed=="C"]<-9.625/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="TF"&Kelp_PAM_no_outlier$treatment_renamed=="HT"]<-9.875/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="TF"&Kelp_PAM_no_outlier$treatment_renamed=="1MH"]<-10.125/2
Kelp_PAM_no_outlier$date_modified[Kelp_PAM_no_outlier$Sampling=="TF"&Kelp_PAM_no_outlier$treatment_renamed=="2MH"]<-10.375/2


Kelp_PAM_no_outlier$date_modified<-as.numeric(Kelp_PAM_no_outlier$date_modified)

Kelp_Pam_alongtime_plot_no_outlier<-ggplot(Kelp_PAM_no_outlier,aes(y=`Fv/Fm`,x=date_modified,color=treatment_renamed))+
  geom_jitter(shape = 16,size=3,alpha=0.8)+
  #geom_smooth(se=F,size=2,alpha=0.5)+
  geom_boxplot(aes(x=date_modified,group=group,fill=treatment_renamed),color="black",outlier.alpha = 0)+
  facet_wrap(species_modified~.,ncol=1)+
  scale_fill_manual(values=c("lightgrey","#92c5de","#E48121","#FC1D28","#901C21"))+
  scale_color_manual(values=c("lightgrey","#92c5de","#E48121","#FC1D28","#901C21"))+
  theme_fira()+
  stat_summary(aes(y=0.60,x=date_modified),colour="black",data=Kelp_PAM_no_outlier,fun.data = give.n, geom = "text",size=8)+
  #scale_x_continuous(label=c("07-02","07-07","07-11","07-14","07-18","07-22"),breaks=c(0,2.5,4.5,6,8,10))+
  scale_x_continuous(label=c("07-02","07-07","07-11","07-14","07-18","07-22"),breaks=c(0,1.25,2.24,3,4,5))+
  scale_y_continuous(limits=c(0.500,0.910),breaks=c(0.55,0.65,0.75,0.85),expand = expansion(mult = c(0,0)))+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
   ylab(bquote(F[v]/F[m]))+
  labs(x="time")

# to do :
# ploter la température (sur un autre graph ? ou par dessus ?)

jpeg(filename = "figures/PAM/Kelp_Pam_alongtime_plot_no_outlier.jpeg",width=950, height=650)
Kelp_Pam_alongtime_plot_no_outlier
dev.off()

# Statistics
# Before to do a repeadted measures ANOVA, 2 assumptions have to be verified :
# 1 : The dependent variable should be normally or near-to-normally distributed for each group. It is worth noting that the t-test is robust for minor violations in normality, however, if your data is very non-normal, it would be worth using a non-parametric test or bootstrapping.
# This first assumption has been verified previoulsy (see Rosner & shapiro tests)

# 2 : The data must have what is known as “sphericity”. This means that amount of variable across the differences for all of the groups (both within and between) must be equal or near-to-equal the variances of the differences between all combinations of related groups must be equal. T
mlm<-stats::lm(`Fv/Fm` ~ treatment_renamed*species*Sampling,data = Kelp_PAM_no_outlier)
mlm<-tidy(mlm)
mauchly.test(mlm)

anova_test(data=Kelp_PAM_no_outlier,dv=`Fv/Fm`,wid=ID,within=c(treatment,Sampling,species,mesocosm))

Anova<-aov(`Fv/Fm` ~ treatment_renamed*species*Sampling, data = Kelp_PAM_no_outlier)
TukeyHSD(Anova)
#
#Fit: aov(formula = `Fv/Fm` ~ treatment * species * Sampling, data = Kelp_PAM_no_outlier)

#$treatment
#              diff         lwr          upr     p adj
#C-T0     0.041277778  0.015269975  0.067285581 0.0001814 ***
#HT-T0    0.045570331  0.020082929  0.071057733 0.0000157 ***
#1MH-T0   0.029954007  0.006302332  0.053605683 0.0052986 ***
#2MH-T0   0.013944444 -0.007884044  0.035772933 0.4023978 
#HT-C     0.004292553 -0.024218463  0.032803569 0.9938368
#1MH-C   -0.011323770 -0.038206332  0.015558791 0.7756826
#2MH-C   -0.027333333 -0.052626678 -0.002039989 0.0268703 *
#1MH-HT  -0.015616324 -0.041995747  0.010763099 0.4819972
#2MH-HT  -0.031625887 -0.056383817 -0.006867956 0.0047773
#2MH-1MH -0.016009563 -0.038873273  0.006854147 0.3074530

#$species
#                             diff         lwr         upr     p adj
#Laminaria-Alaria      0.006723706 -0.009569432  0.02301684 0.5947457
#Saccharina-Alaria    -0.058974844 -0.075187533 -0.04276216 0.0000000
#Saccharina-Laminaria -0.065698551 -0.082030610 -0.04936649 0.0000000

#Let's focus on Saccharina
Kelp_PAM_no_outlier_SL<-Kelp_PAM_no_outlier[Kelp_PAM_no_outlier$species_modified=="SL",]

#summary(P <- powerTransform(`Fv/Fm` ~ treatment_renamed*Sampling, Kelp_PAM_no_outlier_SL))
#Kelp_PAM_no_outlier_SL$new_data<-bcPower(Kelp_PAM_no_outlier_SL$`Fv/Fm`,P$roundlam)

#dataframe<-Kelp_PAM_no_outlier[,2:8]
#dataframe<-dataframe[,-6]
#dataframe<-dataframe[,-4]
#dataframe$treatment<-Kelp_PAM_no_outlier$treatment_renamed
#dataframe<-na.omit(dataframe)

Anova<-aov(`Fv/Fm` ~ treatment_renamed*Sampling*ID, data = Kelp_PAM_no_outlier)

#dataframe$values<-dataframe$`Fv/Fm`
#res.aov <- anova_test(
#  data = dataframe, dv = values, wid = ID,
#  between = c(Sampling))

#pairwise_t_test(dataframe,values ~ Sampling, paired = TRUE, p.adjust.method = "bonferroni") 

TukeyHSD(Anova)
#$treatment
#              diff         lwr           upr     p adj
#C-T0     0.041277778  0.009555863  0.072999693 0.0037726 ***
#HT-T0    0.045570331  0.014483153  0.076657508 0.0006931 ***
#1MH-T0   0.029954007  0.001105879  0.058802136 0.0374456
#2MH-T0   0.013944444 -0.012679929  0.040568818 0.6038428
#HT-C     0.004292553 -0.030482549  0.039067656 0.9971518
#1MH-C   -0.011323770 -0.044112635  0.021465094 0.8777832
#2MH-C   -0.027333333 -0.058183818  0.003517151 0.1097668
#1MH-HT  -0.015616324 -0.047791506  0.016558859 0.6713075
#2MH-HT  -0.031625887 -0.061823322 -0.001428451 0.0349351
#2MH-1MH -0.016009563 -0.043896604  0.011877478 0.5141338

#$Sampling
#                          diff          lwr         upr     p adj
#T0-exp_day1       -0.054534770 -0.086973122 -0.02209642 0.0000335 ***
#exp_day3-exp_day1 -0.070676144 -0.109403507 -0.03194878 0.0000047 ***
#exp_day4-exp_day1 -0.086184652 -0.124589653 -0.04777965 0.0000000 ***
#exp_day2-exp_day1 -0.069266925 -0.104565409 -0.03396844 0.0000006 ***
#TF-exp_day1       -0.057304743 -0.089561604 -0.02504788 0.0000092 ***


# diff T0 vs. day 1: 
#                          diff          lwr         upr     p adj
#T0:T0-C:exp_day1          -0.0755571429 -0.149207345 -0.0019069407 0.0360863 *
#T0:T0-HT:exp_day1         -0.0771404762 -0.148089117 -0.0061918355 0.0158135 *
#T0:T0-1MH:exp_day1        -0.0782844156 -0.151934618 -0.0046342135 0.0221229 *
#T0:T0-2MH:exp_day1        -0.1013263736 -0.169906005 -0.0327467423 0.0000212 ***

# 2MH:
#                                    diff          lwr         upr     p adj
#2MH:exp_day2-2MH:exp_day1 -0.1021025641 -0.184753869 -0.0194512592 0.0016558 ***
#2MH:exp_day3-2MH:exp_day1 -0.1242986425 -0.207963155 -0.0406341297 0.0000181 ***
#2MH:exp_day4-2MH:exp_day1 -0.1309914530 -0.213642758 -0.0483401481 0.0000025 ***


cat(complete_code("Un code qui test la différence statistique de Fv/Fm dans le dataframe Kelp_PAM_no_outlier en fonction du temps (Date) et des conditons subis (treatment), du réplicas de conditions (mesocosm) et de l'espèce (Alaria, Laminaria et Saccharina) en utilisant une anova avec des mesures répétées dans le temps et un test post hoc de tukey"))


analyse_FvFm <- function(Kelp_PAM_no_outlier){
  # Library pour les tests statistiques
  library(nlme)
  
  # Modèle mixte pour l'analyse de variance
  model <- lme(data = Kelp_PAM_no_outlier,
               fixed = FvFm ~ Date + treatment + Species,
               random = ~1|mesocosm,
               na.action = na.exclude) # Ignorer les valeurs manquantes
  
  # Analyse de variance
  anova <- anova(model)
  
  # Résultats
  return(anova)
}

TukeyHSD(anova)
#### CORALLINE ####
Coralline_PAM <- read_excel("data/Coralline_PAM_data.xlsx")
give.n <- function(x){
   return(c(y = mean(x), label = length(x)))
}
Coralline_PAM$treatment_renamed <- "C"
Coralline_PAM$treatment_renamed[Coralline_PAM$treatment=="C1"] <- "HT"
Coralline_PAM$treatment_renamed[Coralline_PAM$treatment=="C2"] <- "1MH"
Coralline_PAM$treatment_renamed[Coralline_PAM$treatment=="C3"] <- "2MH"

Coralline_PAM$treatment_renamed <- fct_relevel(Coralline_PAM$treatment_renamed, c("C","HT","1MH","2MH"))

# All period merged
ggplot(Coralline_PAM,aes(y=`Fv/Fm`,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(shape = 21,color="black",size=3)+
  scale_fill_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.31,x=treatment_renamed),colour="black",data=Coralline_PAM,fun.data = give.n, geom = "text",size=10)+
  scale_y_continuous(breaks=c(0.30,0.40,0.50,0.60,0.70))+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
   ylab(bquote(F[v]/F[m]))+
  labs(x="conditions")

Coralline_PAM$group<-paste0(Coralline_PAM$treatment_renamed,Coralline_PAM$Date,sep="_")
Coralline_PAM$Date_modified<-1
Coralline_PAM$Date_modified[Coralline_PAM$Sampling=="exp_day2"]<-2

ggplot(Coralline_PAM,aes(y=`Fv/Fm`,x=Date_modified,color=treatment_renamed))+
  geom_jitter(shape = 16,size=3,alpha=0.8)+
  #geom_smooth(se=F,size=2,alpha=0.5)+
  geom_boxplot(aes(x=Date_modified,group=group,fill=treatment_renamed),color="black",outlier.alpha = 0)+
  scale_fill_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  scale_color_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  theme_fira()+
  scale_x_continuous(breaks=c(1,2),label=c("July 12", "July 20"))+
  scale_y_continuous(breaks=c(0.30,0.40,0.50,0.60,0.70))+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
   ylab(bquote(F[v]/F[m]))+
  labs(x="conditions")


# is there any outlier ?
Coralline_PAM_C0<-Coralline_PAM[Coralline_PAM$treatment=="C0",]
ggqqplot(Coralline_PAM_C0$`Fv/Fm`)
rosnerTest(Coralline_PAM_C0$`Fv/Fm`, k = 1)$all.stats # no outlier
shapiro.test(Coralline_PAM_C0$`Fv/Fm`) # Normal

Coralline_PAM_C1<-Coralline_PAM[Coralline_PAM$treatment=="C1",]
ggqqplot(Coralline_PAM_C1$`Fv/Fm`)
rosnerTest(Coralline_PAM_C1$`Fv/Fm`, k = 1)$all.stats # no outlier
shapiro.test(Coralline_PAM_C1$`Fv/Fm`) #Normal

Coralline_PAM_C2<-Coralline_PAM[Coralline_PAM$treatment=="C2",]
ggqqplot(Coralline_PAM_C2$`Fv/Fm`)
rosnerTest(Coralline_PAM_C2$`Fv/Fm`, k = 1)$all.stats # 1 outlier : 0.707 
Coralline_PAM_C2<-Coralline_PAM_C2[!Coralline_PAM_C2$`Fv/Fm`==0.707 ,]
shapiro.test(Coralline_PAM_C2$`Fv/Fm`) 

Coralline_PAM_C3<-Coralline_PAM[Coralline_PAM$treatment=="C3",]
ggqqplot(Coralline_PAM_C3$`Fv/Fm`)
rosnerTest(Coralline_PAM_C3$`Fv/Fm`, k = 1)$all.stats # no outlier
shapiro.test(Coralline_PAM_C3$`Fv/Fm`) #Normal

Coralline_PAM<-Coralline_PAM[!Coralline_PAM$`Fv/Fm`==0.707 ,]

# Plots without the outlier:
Coralline_Pam_allperiod_plot_no_outlier<-ggplot(Coralline_PAM,aes(y=`Fv/Fm`,x=treatment_renamed,fill=treatment_renamed))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(shape = 21,color="black",size=3)+
  scale_fill_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.31,x=treatment_renamed),colour="black",data=Coralline_PAM,fun.data = give.n, geom = "text",size=10)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
   ylab(bquote(F[v]/F[m]))+
  labs(x="conditions")

jpeg(filename = "figures/PAM/Coralline_Pam_allperiod_plot_no_outlier.jpeg",width=950, height=650)
Coralline_Pam_allperiod_plot_no_outlier
dev.off()


Coralline_PAM$Date_modified_treatment<-paste0(Coralline_PAM$Date_modified,sep="_",Coralline_PAM$treatment)

Coralline_PAM$x_axis <- 0.25
Coralline_PAM$x_axis[Coralline_PAM$Date_modified_treatment=="1_C1"] <- 0.5
Coralline_PAM$x_axis[Coralline_PAM$Date_modified_treatment=="1_C2"] <- 0.75
Coralline_PAM$x_axis[Coralline_PAM$Date_modified_treatment=="1_C3"] <- 1

Coralline_PAM$x_axis[Coralline_PAM$Date_modified_treatment=="2_C0"] <- 1.5
Coralline_PAM$x_axis[Coralline_PAM$Date_modified_treatment=="2_C1"] <- 1.75
Coralline_PAM$x_axis[Coralline_PAM$Date_modified_treatment=="2_C2"] <- 2
Coralline_PAM$x_axis[Coralline_PAM$Date_modified_treatment=="2_C3"] <- 2.25


Coralline_PAM_alongtime_plot_no_outlier<-ggplot(Coralline_PAM,aes(y=`Fv/Fm`,x=x_axis,color=treatment_renamed))+
  geom_jitter(shape = 16,size=3,alpha=0.8)+
  #geom_smooth(se=F,size=2,alpha=0.5)+
  geom_boxplot(aes(x=x_axis,group=group,fill=treatment_renamed),color="black",outlier.alpha = 0)+
  scale_fill_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  scale_color_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.31,x=x_axis),colour="black",data=Coralline_PAM,fun.data = give.n, geom = "text",size=10)+
  scale_x_continuous(breaks=c(0.625,1.875),label=c("July 12", "July 20"))+
  scale_y_continuous(breaks=c(0.30,0.40,0.50,0.60,0.70))+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
   ylab(bquote(F[v]/F[m]))+
  labs(x="conditions")

jpeg(filename = "figures/PAM/Coralline_PAM_alongtime_plot_no_outlier.jpeg",width=950, height=650)
Coralline_PAM_alongtime_plot_no_outlier
dev.off()

Anova<-aov(`Fv/Fm` ~ treatment_renamed*Sampling, data = Coralline_PAM)
TukeyHSD(Anova)
#2MH-HT   0.05468000  0.00267948 0.10668052 0.0353672 *
#2MH-1MH  0.05303000  0.00049060 0.10556940 0.0470159 *

#HT:exp_day2-2MH:exp_day1  -0.090209790 -0.17948538 -0.0009342011 0.0457796 *
#2MH:exp_day2-HT:exp_day2   0.103613636  0.01264911  0.1945781653 0.0142854 *

```

## 4° Growth <br>
```{r Growth , echo=FALSE, warning=FALSE, message=FALSE, results=FALSE,fig.width=15,fig.height=10}
# KELP ####
Growth <-  read_excel("data/GROWTH.xlsx", 
     col_types = c("text", "numeric", "text", 
         "text", "text", "text", "numeric", 
         "numeric", "text", "text", "text"))

# Data manipulation ####
#Growth<- na.omit(Growth) #Remove NA
Growth$treatment <- fct_relevel(Growth$treatment, c("C0","C1","C2","C3"))

# Plots  ####
give.n <- function(x){
   return(c(y = mean(x), label = length(x)))
}


# Mean for barplot
#Growth_mean<-Growth %>%
#  drop_na(Growth_rate)%>%
#  group_by(species,treatment) %>%
#  summarise(mean_growth=mean(Growth_rate))%>%
#  ungroup()

#Growth<-inner_join(Growth,Growth_mean,by=c("species","treatment"))

# std for barplot
#Growth_sd<-Growth %>%
#  drop_na(Growth_rate)%>%
#  group_by(species,treatment) %>%
#  summarise(sd_growth=sd(Growth_rate))%>%
#  ungroup()

#Growth<-inner_join(Growth,Growth_sd,by=c("species","treatment"))

Growth$treatment_renamed <- "C"
Growth$treatment_renamed[Growth$treatment=="C1"] <- "HT"
Growth$treatment_renamed[Growth$treatment=="C2"] <- "1MH"
Growth$treatment_renamed[Growth$treatment=="C3"] <- "2MH"

Growth$treatment_renamed<-fct_relevel(Growth$treatment_renamed, c("C","HT","1MH","2MH"))

Growth_plot<-ggplot(Growth,aes(x=treatment_renamed,fill=treatment_renamed))+
  #geom_bar(aes(y=mean_growth),stat='identity',color="black", position=position_dodge()) +
  #geom_errorbar(aes(ymin=mean_growth-sd_growth, ymax=mean_growth+sd_growth),width=.2,position=position_dodge(.9))+
  geom_boxplot(aes(y=Growth_rate),outlier.alpha = 0)+
  geom_jitter(shape = 21,aes(y=Growth_rate,fill=treatment_renamed),color="black",size=3)+
  facet_wrap(~species)+
  scale_fill_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.4,x=treatment_renamed),colour="black",data=Growth,fun.data = give.n, geom = "text",size=10)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  labs(y="Growth rate (cm/day)",x="conditions")

jpeg(filename = "figures/Growth/Growth_rate_kelp.jpeg",width=950, height=650)
Growth_plot
dev.off()

# Growth rate vary with total lenght, let's take this variable into account by creating a model
################ Based on a script of Daniel Liesner ##########
Kelp_ID <- read_excel("data/Kelp_ID.xlsx", 
     col_types = c("numeric", "text", "numeric", 
         "text", "text", "numeric", "numeric", 
         "numeric", "text", "text", "text"))
Growth_normalized<-merge(Kelp_ID,Growth,by="ID")
Growth_normalized$`Total lenght (cm)`
### visually identify effects of initial length (covariate) on growth rates
library(nlme)
library(ggu.base.fun)
# log transformation is necessary to look into a LINEAR model here
# It allows the residuals to be normaly distributed (see later)
Growth_normalized$lg_growth_rate<-log(Growth_normalized$Growth_rate)
Growth_normalized$lg_total_lenght<-log(Growth_normalized$`Total lenght (cm)`)

Growth_normalized <- Growth_normalized[!is.infinite(Growth_normalized$lg_growth_rate),] #remove inf values
Growth_normalized <- Growth_normalized[!is.na(Growth_normalized$lg_growth_rate),] # remove NA

length_lm <- lm(lg_growth_rate ~ lg_total_lenght,data=Growth_normalized)
plot(lg_growth_rate ~ lg_total_lenght,data=Growth_normalized)
abline(length_lm)
summary(length_lm)
legend("topleft",legend=paste("R2 is", format(summary(length_lm)$r.squared,digits=3)))
# equation : log(y)=4.2797 + (-1.5663)*log(total_lenght) + 1.024
Growth_normalized$Normalized_growth_rate<-10^(4.2797 + (-1.5663)*Growth_normalized$lg_total_lenght + 1.024)

# normality of standardized model residuals
length_lm_std <- residuals(length_lm, type="pearson")
shapiro.test(length_lm_std) #p-value = 0.108, normality verified
qqnorm(length_lm_std)
qqline(length_lm_std)
hist(length_lm_std, xlab="standardized residuals")

library(car)
# homogeneity of model variances
leveneTest(length_lm_std , group = Growth_normalized$lg_growth_rate) # Homogeneity verified
leveneTest(length_lm_std , group = Growth_normalized$lg_total_lenght) # Homogeneity verified

### ANOVA for the final model
anova(length_lm)
#Analysis of Variance Table
#Response: lg_growth_rate
#                 Df  Sum Sq Mean Sq F value    Pr(>F)    
#lg_total_lenght   1  32.777  32.777  31.274 1.081e-07 ***
#Residuals       145 151.971   1.048                      
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Normalized_growth_rate_kelp<-ggplot(Growth_normalized,aes(x=treatment_renamed,fill=treatment_renamed))+
  #geom_bar(aes(y=mean_growth),stat='identity',color="black", position=position_dodge()) +
  #geom_errorbar(aes(ymin=mean_growth-sd_growth, ymax=mean_growth+sd_growth),width=.2,position=position_dodge(.9))+
  geom_boxplot(aes(y=Normalized_growth_rate),outlier.alpha = 0)+
  geom_jitter(shape = 21,aes(y=Normalized_growth_rate,fill=treatment_renamed),color="black",size=3)+
  facet_wrap(~species)+
  scale_fill_manual(values=c("#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.2,x=treatment_renamed),colour="black",data=Growth_normalized,fun.data = give.n, geom = "text",size=10)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  labs(y="Growth rate (cm/day)",x="conditions")

jpeg(filename = "figures/Growth/Normalized_growth_rate_kelp.jpeg",width=950, height=650)
Normalized_growth_rate_kelp
dev.off()

Anova<-aov(Normalized_growth_rate ~ treatment_renamed*species, data = Growth_normalized)
TukeyHSD(Anova)
#              diff          lwr          upr     p adj
#LD-AE -0.026614743 -0.046235063 -0.006994423 0.0046274 ***
#SL-AE  0.008508069 -0.008432724  0.025448862 0.4610589
#SL-LD  0.035122812  0.013309118  0.056936507 0.0006001 ***

# CORALLINE ####
Corraline_growth <- read_excel("data/Corraline_growth.xlsx")
Corraline_growth$treatment_renamed <- "C"
Corraline_growth$treatment_renamed[Corraline_growth$treatment=="C1"] <- "HT"
Corraline_growth$treatment_renamed[Corraline_growth$treatment=="C2"] <- "1MH"
Corraline_growth$treatment_renamed[Corraline_growth$treatment=="C3"] <- "2MH"

Corraline_growth$treatment_renamed<-fct_relevel(Corraline_growth$treatment_renamed, c("C","HT","1MH","2MH"))

# Plots  ####
give.n <- function(x){
   return(c(y = mean(x), label = length(x)))
}

#The average composition of minerals in the shells is approximately 90 percent calcite and 10 percent aragonite (Hutchinson and O'Sullivan 2008).
Corraline_growth$density_T0 <- rho(S=33, T=Corraline_growth$T0_Temperature_BW, P=0)
Corraline_growth$dry_weight_T0 <- Corraline_growth$T0_Buyant_weight*(1-((Corraline_growth$density_T0/1000)*((2.93^-1)*0.1+((2.71^-1)*0.9)))) 

Corraline_growth$density_TF <- rho(S=33, T=Corraline_growth$TF_Temperature_BW, P=0)
Corraline_growth$dry_weight_TF <- Corraline_growth$TF_Buyant_weight*(1-((Corraline_growth$density_TF/1000)*((2.93^-1)*0.1+((2.71^-1)*0.9))))

Corraline_growth$delta_dry_weight<-Corraline_growth$dry_weight_TF-Corraline_growth$dry_weight_T0

# 8 outliers : -42.69, -39.48, -19.37
ggqqplot(Corraline_growth$delta_dry_weight)
shapiro.test(Corraline_growth$delta_dry_weight) # not normal
rosnerTest(Corraline_growth$delta_dry_weight, k = 8)$all.stats  # 8 outliers
Corraline_growth<-Corraline_growth[!Corraline_growth$Delta_BW==-42.69,]
Corraline_growth<-Corraline_growth[!Corraline_growth$ID==9,]
Corraline_growth<-Corraline_growth[!Corraline_growth$Delta_BW==-19.37,]
Corraline_growth<-Corraline_growth[!Corraline_growth$ID==70,]
Corraline_growth<-Corraline_growth[!Corraline_growth$ID==8,]
Corraline_growth<-Corraline_growth[!Corraline_growth$ID==69,]
Corraline_growth<-Corraline_growth[!Corraline_growth$ID==68,]
Corraline_growth<-Corraline_growth[!Corraline_growth$ID==74,]
shapiro.test(Corraline_growth$delta_dry_weight) # normal

Corraline_growth_plot_no_outlier<-ggplot(Corraline_growth,aes(x=treatment_renamed,fill=treatment_renamed))+
  #geom_bar(aes(y=mean_growth),stat='identity',color="black", position=position_dodge()) +
  #geom_errorbar(aes(ymin=mean_growth-sd_growth, ymax=mean_growth+sd_growth),width=.2,position=position_dodge(.9))+
  geom_boxplot(aes(y=delta_dry_weight),outlier.alpha = 0)+
  geom_jitter(shape = 21,aes(y=delta_dry_weight,fill=treatment_renamed),color="black",size=3)+
  scale_fill_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.4,x=treatment_renamed),colour="black",data=Corraline_growth,fun.data = give.n, geom = "text",size=10)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  labs(y="Delta dry weight (g)",x="conditions")

jpeg(filename = "figures/Growth/Corraline_growth_plot_no_outlier.jpeg",width=950, height=650)
Corraline_growth_plot_no_outlier
dev.off()

Anova<-aov(delta_dry_weight ~ treatment*mesocosm, data = Corraline_growth)
TukeyHSD(Anova)
# NOTHING

# SNAILS ####
snails_growth <- read_excel("data/snails_growth.xlsx", 
     col_types = c("text", "numeric", "text", 
         "numeric", "numeric", "numeric", 
         "date", "numeric", "numeric", "numeric", 
         "numeric", "text", "date", "text", "text", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "text", "numeric"))

snails_growth$density_T0 <- rho(S=33, T=snails_growth$T0_Temperature_BW, P=0)
snails_growth$dry_weight_T0 <- snails_growth$T0_Buyant_weight*(1-((snails_growth$density_T0/1000)*((2.93^-1)*0.1+((2.71^-1)*0.9)))) 

snails_growth$density_TF <- rho(S=33, T=snails_growth$TF_Temperature_BW, P=0)
snails_growth$dry_weight_TF <- snails_growth$TF_Buyant_weight*(1-((snails_growth$density_TF/1000)*((2.93^-1)*0.1+((2.71^-1)*0.9))))

snails_growth$delta_dry_weight<-snails_growth$dry_weight_TF-snails_growth$dry_weight_T0

ggqqplot(snails_growth$delta_dry_weight)
shapiro.test(snails_growth$delta_dry_weight) # not normal
rosnerTest(snails_growth$delta_dry_weight, k = 6)$all.stats  # 11 outliers
snails_growth$ID_color<-paste(snails_growth$ID,snails_growth$Color,sep="_")
snails_growth<-snails_growth[!snails_growth$ID_color=="12_White",]
snails_growth<-snails_growth[!snails_growth$ID_color=="17_Red",]
snails_growth<-snails_growth[!snails_growth$ID_color=="8_Gold",]
snails_growth<-snails_growth[!snails_growth$ID_color=="9_White",]
snails_growth<-snails_growth[!snails_growth$ID_color=="7_Red",]
snails_growth<-snails_growth[!snails_growth$ID_color=="13_White",]
snails_growth<-snails_growth[!snails_growth$ID_color=="11_White",]
snails_growth<-snails_growth[!snails_growth$ID_color=="5_Red",]
snails_growth<-snails_growth[!snails_growth$ID_color=="14_Blue",]
snails_growth<-snails_growth[!snails_growth$ID_color=="14_Red",]
snails_growth<-snails_growth[!snails_growth$ID_color=="5_Gold",]
shapiro.test(snails_growth$delta_dry_weight) # normal

snails_growth$treatment_renamed <- "C"
snails_growth$treatment_renamed[snails_growth$treatment=="C1"] <- "HT"
snails_growth$treatment_renamed[snails_growth$treatment=="C2"] <- "1MH"
snails_growth$treatment_renamed[snails_growth$treatment=="C3"] <- "2MH"

snails_growth$treatment_renamed<-fct_relevel(snails_growth$treatment_renamed, c("C","HT","1MH","2MH"))


Snails_growth_plot_no_outlier<-ggplot(snails_growth,aes(x=treatment_renamed,fill=treatment_renamed))+
  #geom_bar(aes(y=mean_growth),stat='identity',color="black", position=position_dodge()) +
  #geom_errorbar(aes(ymin=mean_growth-sd_growth, ymax=mean_growth+sd_growth),width=.2,position=position_dodge(.9))+
  geom_boxplot(aes(y=delta_dry_weight),outlier.alpha = 0)+
  geom_jitter(shape = 21,aes(y=delta_dry_weight,fill=treatment_renamed),color="black",size=3)+
  scale_fill_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.6,x=treatment_renamed),colour="black",data=snails_growth,fun.data = give.n, geom = "text",size=10)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  labs(y="Delta dry weight (g)",x="conditions")

jpeg(filename = "figures/Growth/Snails_growth_plot_no_outlier.jpeg",width=950, height=650)
Snails_growth_plot_no_outlier
dev.off()

Anova<-aov(delta_dry_weight ~ treatment*mesocosm, data = snails_growth)
TukeyHSD(Anova)
# NOTHING

# MUSSELS ####

Mussels_growth <- read_excel("data/Mussels_growth.xlsx", 
     col_types = c("text", "text", "numeric", 
         "numeric", "numeric", "date", "text", 
         "numeric", "numeric", "numeric", 
         "numeric", "date", "text", "text", 
         "text"))

Mussels_growth$density_T0 <- rho(S=33, T=Mussels_growth$T0_Temperature_BW, P=0)
Mussels_growth$dry_weight_T0 <- Mussels_growth$T0_Buyant_weight*(1-((Mussels_growth$density_T0/1000)*((2.93^-1)*0.1+((2.71^-1)*0.9)))) 

Mussels_growth$density_TF <- rho(S=33, T=Mussels_growth$TF_Temperature_BW, P=0)
Mussels_growth$dry_weight_TF <- Mussels_growth$TF_Buyant_weight*(1-((Mussels_growth$density_TF/1000)*((2.93^-1)*0.1+((2.71^-1)*0.9))))

Mussels_growth$delta_dry_weight<-Mussels_growth$dry_weight_TF-Mussels_growth$dry_weight_T0

ggqqplot(Mussels_growth$delta_dry_weight)
shapiro.test(Mussels_growth$delta_dry_weight) # not normal
rosnerTest(Mussels_growth$delta_dry_weight, k = 12)$all.stats  # 12 outliers
Mussels_growth$ID_color<-paste(Mussels_growth$ID,Mussels_growth$Color,sep="_")
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="3_Doré",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="1_White",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="1_Red",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="1_Blue",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="8_Gold",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="5_White",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="6_Gold",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="10_Red",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="6_White",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="5_Red",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="10_White",]
Mussels_growth<-Mussels_growth[!Mussels_growth$ID_color=="8_Red",]
shapiro.test(Mussels_growth$delta_dry_weight) # normal

Mussels_growth$treatment_renamed <- "C"
Mussels_growth$treatment_renamed[Mussels_growth$treatment=="C1"] <- "HT"
Mussels_growth$treatment_renamed[Mussels_growth$treatment=="C2"] <- "1MH"
Mussels_growth$treatment_renamed[Mussels_growth$treatment=="C3"] <- "2MH"

Mussels_growth$treatment_renamed<-fct_relevel(Mussels_growth$treatment_renamed, c("C","HT","1MH","2MH"))


Mussels_growth_plot_no_outlier<-ggplot(Mussels_growth ,aes(x=treatment_renamed,fill=treatment_renamed))+
  #geom_bar(aes(y=mean_growth),stat='identity',color="black", position=position_dodge()) +
  #geom_errorbar(aes(ymin=mean_growth-sd_growth, ymax=mean_growth+sd_growth),width=.2,position=position_dodge(.9))+
  geom_boxplot(aes(y=delta_dry_weight),outlier.alpha = 0)+
  geom_jitter(shape = 21,aes(y=delta_dry_weight,fill=treatment_renamed),color="black",size=3)+
  scale_fill_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=0.5,x=treatment_renamed),colour="black",data=Mussels_growth ,fun.data = give.n, geom = "text",size=10)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  labs(y="Delta dry weight (g)",x="conditions")

jpeg(filename = "figures/Growth/Mussels_growth_plot_no_outlier.jpeg",width=950, height=650)
Mussels_growth_plot_no_outlier
dev.off()

Anova<-aov(delta_dry_weight ~ treatment*mesocosm, data = Mussels_growth)
TukeyHSD(Anova)
# NOTHING

# URCHINS ####
urchins_biomass <- read_excel("data/urchins_biomass.xlsx", 
     col_types = c("text", "text", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric"))
urchins_biomass_sum_n_TF <-urchins_biomass %>%
  group_by(treatment)%>%
  summarise(sum_n_TF=sum(n_TF))

urchins_biomass<-merge(urchins_biomass_sum_n_TF,urchins_biomass,by="treatment")

urchins_biomass$treatment_renamed <- "C"
urchins_biomass$treatment_renamed[urchins_biomass$treatment=="C1"] <- "HT"
urchins_biomass$treatment_renamed[urchins_biomass$treatment=="C2"] <- "1MH"
urchins_biomass$treatment_renamed[urchins_biomass$treatment=="C3"] <- "2MH"

urchins_biomass$treatment_renamed<-fct_relevel(urchins_biomass$treatment_renamed, c("C","HT","1MH","2MH"))


urchins_biomass_plot<-ggplot(urchins_biomass ,aes(x=treatment_renamed,fill=treatment_renamed))+
  #geom_bar(aes(y=mean_growth),stat='identity',color="black", position=position_dodge()) +
  #geom_errorbar(aes(ymin=mean_growth-sd_growth, ymax=mean_growth+sd_growth),width=.2,position=position_dodge(.9))+
  geom_boxplot(aes(y=Delta_BW_n),outlier.alpha = 0)+
  #geom_label(aes(y=-6,x=treatment_renamed,label=sum_n_TF),fill="white",size=12)+
  geom_text(aes(y=-7,x=treatment_renamed,label=sum_n_TF),fill="white",size=10)+
  geom_jitter(shape = 21,aes(y=Delta_BW_n,fill=treatment_renamed),color="black",size=3)+
  scale_fill_manual(values=c("#cccccc","#92c5de","#E48121","#FC1D28","#901C21"))+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="none")+
  labs(y="Delta wet weight (g)",x="conditions")

jpeg(filename = "figures/Growth/urchins_biomass_plot.jpeg",width=950, height=650)
urchins_biomass_plot
dev.off()


Anova<-aov(Delta_BW_n~ treatment, data = urchins_biomass)
TukeyHSD(Anova)
# Nothing
```

## 5° O2 <br>
```{r raw data,echo=FALSE,warning=FALSE,fig.width=15,fig.height=15}
O2_data <- read_excel("data/O2-data.xlsx", 
     col_types = c("text", "numeric", "text", 
         "text", "numeric", "date", "text", 
         "numeric", "text", "text", "numeric", "numeric", 
         "numeric", "text"))
O2_data$DateTime<-paste(O2_data$date,O2_data$time) 
O2_data$grp<-paste(O2_data$ID,"_",O2_data$date)
O2_data$date<-as.character(O2_data$date)
O2_data<-O2_data %>% 
    mutate(week = coalesce(week,date))

# graph O2 concentration with time for each ID
ggplot(O2_data,aes(dt,O2))+
  geom_point(aes(color=week))+
  geom_line(aes(group=grp))+
  facet_wrap(~ID+species)
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), face = "bold"),
        axis.text = element_text(size = rel(1.5)),
        legend.title = element_text(size = rel(1.5), face = "bold"),
        plot.title = element_text(size=30, face="bold.italic",hjust = 0.5))+
  ggtitle("O2 curves before cleaning")

O2_data_120<-O2_data[O2_data$ID=="120",]
ggplot(O2_data_120,aes(dt,O2))+
  geom_point(aes(color=week,shape=date))+
  geom_line(aes(group=grp,shape=date))+
  facet_wrap(~week)+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), face = "bold"),
        axis.text = element_text(size = rel(1.5)),
        legend.title = element_text(size = rel(1.5), face = "bold"),
        plot.title = element_text(size=30, face="bold.italic",hjust = 0.5))+
  ggtitle("O2 curves before cleaning")
  
```

 1° Data cleaning

During a light incubation of any photosynthetic organisms, $O_{2}$ progressively increase with time if photosynthesis occurs. However, for some reasons we can sometimes see outliers in the $O_{2}$ measurement. Theses outliers need to be removed before any analysis. This is the purpose of this 1st step.

Here are plotted the raw $O_{2}$ measurements after removal of the outliers. We removed : 1) complete graphs when values are way too high &/or variable, 2) all values after 30min of incubations, 3) the first 5mins of incubation, 4) ponctual measurement not following the general trend of a graph.

```{r O2 cleaning,echo=FALSE,warning=FALSE,fig.width=15,fig.height=15}

# A) Remove complete graph when values are way too high & variable
Weird_graphs<-O2_data %>%
  filter(ID==52 & date=="2022-07-10" 
         |ID==17 & week=="2022-07-12" & dt>=1800
         |ID==17 & week=="2022-07-12" & dt<=20
         |ID==33 & week=="2022-07-10" & dt<=200
         |ID==36 & week=="2022-07-10" & dt<=200
         |ID==42 & week=="2022-07-10" & dt>=1350
         |ID==42 & week=="2022-07-10" & dt<=10
         |ID==45 & week=="2022-07-10" & dt<=350
         |ID==52 & week=="2022-07-05" & dt<=2000
         |ID==52 & week=="2022-07-10" & dt<=700
         |ID==52 & week=="DARK" & date=="2022-07-19"
         |ID==54 & week=="2022-07-02" & dt<=2000
         |ID==54 & week=="2022-07-10" & dt<=700
         |ID==54 & mesocosm=="C3M1"
         |ID==58 & week=="2022-07-10" & dt<=500
         |ID==62 & week=="2022-07-10" & dt<=1000
         |ID==78 & week=="2022-07-10"
         |ID==78 & week=="T0" & dt<=200
         |ID==84 & week=="DARK" & date=="2022-07-19" & dt<=1000
         |ID==84 & week=="DARK" & date=="2022-07-19" & dt>=2700
         |ID==86 & dt<=50
         |ID==89 & dt<=50
         |ID==81 & dt<=50
         |ID==48 & dt<=50
         |ID==106 & week=="2022-07-14" & dt<=600
         |ID==113 & week=="2022-07-18" & dt<=1100
         |ID==113 & week=="DARK" & date=="2022-07-19" & dt<=500
         |ID==113 & week=="DARK" & date=="2022-07-19" & dt>=1450
         |species=="Blank3"
         |species=="Blank4"
         |ID==46 & week=="2022-07-05" & dt<=750
         |ID==46 & week=="2022-07-05" & dt>=1550
         |ID==46 & week=="T0" & dt<=500
         |ID==46 & week=="T0" & dt>=1500
         |ID==48 & week=="T0" & dt>=1500
         |ID==56 & week=="2022-07-10"
         |ID==56 & week=="DARK" & dt<=1000
         |ID==56 & week=="DARK" & dt<=2500
         |ID==65 & week=="2022-07-05" & dt<=2000
         |ID==77 & week=="DARK" & date=="2022-07-21" & dt<=450
         |ID==80 & week=="2022-07-14" & dt<=450
         |ID==99 & week=="2022-07-18"
         |ID==107 & week=="2022-07-18" & dt<=50
         |ID==107 & week=="DARK" & date =="2022-07-19"
         |ID==120 & week=="TF"
         |ID==120 & week=="2022-07-14" & dt<=350
         |ID==120 & week=="2022-07-14" & dt>=1100)

O2_data <- anti_join(O2_data,
                            Weird_graphs, by = c("ID","week","dt"))
rm(Weird_graphs)

ggplot(O2_data,aes(dt,O2))+
  geom_point(aes(color=week))+
  geom_line(aes(group=grp))+
  facet_wrap(~ID+species)
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), face = "bold"),
        axis.text = element_text(size = rel(1.5)),
        legend.title = element_text(size = rel(1.5), face = "bold"),
        plot.title = element_text(size=30, face="bold.italic",hjust = 0.5))+
  ggtitle("O2 curves before cleaning")

```

A second step  is to check the temperature measurements during the incubation. Indeed the temperature influences the O2 calculation. Therefore, it is important to verify that the values of the temperatures used in the calculation do not seem aberrant.

```{r Temperature cleaning,echo=FALSE,warning=FALSE,fig.width=15,fig.height=15}
ggplot(O2_data,aes(dt,Temp))+
  geom_point(aes(color=week))+
  geom_line(aes(group=grp))+
  facet_wrap(~ID+species)
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), face = "bold"),
        axis.text = element_text(size = rel(1.5)),
        legend.title = element_text(size = rel(1.5), face = "bold"),
        plot.title = element_text(size=30, face="bold.italic",hjust = 0.5))+
  ggtitle("O2 curves before cleaning")
  
```

The temperature data look good. We don't have to remove any outliers.

 2° Model & slopes calculation

The second step is to calculate the slope of $O_{2}$ from T0 to TF based on a linear model to obtain the $\Delta(O_{2}$).

```{r Model,echo=FALSE,warning=FALSE,results=FALSE,fig.show='hide'}
LM<- O2_data %>%
  group_by(grp) %>%
  do(broom::tidy(lm(O2~dt, .)))

LM<-LM[LM$term=="dt",]
O2_data <- merge(O2_data, LM, by = 'grp')
O2_data_estimate <- O2_data %>% distinct(estimate, .keep_all = TRUE)
rm(LM)
# graph O2 with model per grp
ggplot(O2_data,aes(dt,O2))+
  geom_point(color="grey60")+
  geom_line(aes(group=grp))+
  geom_smooth(aes(group=grp),method="lm",formula="y ~ x")+
  stat_regline_equation() +
  theme_minimal()+
  theme(axis.title = element_text(size = rel(1.5), face = "bold"),
        axis.text = element_text(size = rel(1.5)),
        legend.title = element_text(size = rel(1.5), face = "bold"))+
  facet_wrap(~ID+species)
```

 3° Normalization <br>

The third step is to normalize the $O_{2}$(µmol.L) rate with the biomass of the individual.

$$
normalizedO_{2} (umol.g(dw)^-.^1min^-.^1) =  \frac{O_{2} (umol/L.min) * V(L)} {Biomass (g)}
$$ <br> with V = Volume of the chamber, in L (V=29L for the big chamber and V=23L for the small chamber) <br>

In our case we used the dry weight (g). Each individual has been weighted before each incubation. We use a regression relation between the wet & the dry weight to calculate the dry weight from the wet one at each incubation time.

 4° O2 Results <br>

```{r Normalization & O2 results, echo=FALSE, warning=FALSE, message=FALSE, results=FALSE,fig.width=15,fig.height=10}

# Merge O2 & PAR data 
O2_data$DateTime<-as_datetime(O2_data$DateTime)
O2_data$DateTime_rounded<-lubridate::round_date(
  O2_data$DateTime,
  unit = "5 min")

PAR <- read_excel("data/O2-data.xlsx",sheet = "PAR", col_types = c("date", "date", "numeric"))
PAR <- separate(PAR ,Time, c("bin","time"), sep = " ")
PAR <- select(PAR,-bin)
PAR$DateTime_rounded <- paste(PAR$Date,"",PAR$time)

O2_data$DateTime_rounded<-as_datetime(O2_data$DateTime_rounded)
PAR$DateTime_rounded<-as_datetime(PAR$DateTime_rounded)
O2_PAR <- inner_join(O2_data, PAR, by = "DateTime_rounded") 
rm(PAR)

# add DARK incubations
O2_DARK<-O2_data[O2_data$week=="DARK",] #Add dark incubations
O2_DARK$Date<-O2_DARK$date
O2_DARK$time.y<-O2_DARK$time
O2_DARK$PAR<-0

O2_PAR <- O2_PAR %>% 
        rename("time" = "time.x")

O2_PAR <- rbind(O2_PAR,O2_DARK)
rm(O2_DARK)

O2_PAR$mesocosm[O2_PAR$week=="T0"]<-"T0"

# Add the dry weight
Kelp_ID <- read_excel("data/Kelp_ID.xlsx", 
     col_types = c("numeric", "text", "numeric", 
         "text", "text", "numeric", "numeric", 
         "numeric", "text", "text", "text"))
O2_PAR_DW <- inner_join(O2_PAR,Kelp_ID, by = "ID") # merge O2 & PAR data
rm(Kelp_ID)

#Calculate the dry weight using a regression formula 
# SL
SL<-O2_PAR_DW[O2_PAR_DW$species=="Saccharina",]
SL$Dry_weight<-(SL$`Wet_weight (g)`*0.1664)+0.1548
# AE
AE<-O2_PAR_DW[O2_PAR_DW$species=="Alaria",]
AE$Dry_weight<-(AE$`Wet_weight (g)`*0.2614)-3.1997

O2_PAR_DW<-rbind(SL,AE)
rm(SL,AE)

O2_PAR_DW_test<-O2_PAR_DW %>%
  select(grp,mesocosm,species,week,Dry_weight,ID,PAR,O2) %>%
  group_by(grp,mesocosm,species,week,Dry_weight,ID)%>%
  summarise(PAR = sum(PAR)/length(PAR)) #mean of PAR received during each incubation (*60 because 1 measure every minute but PAR in sec-1)
# PAR in μmol m-2 s-1

#O2_data_estimate <- O2_PAR_DW_test %>% distinct(estimate, .keep_all = TRUE)

O2_data_estimate$mesocosm[O2_data_estimate$week=="T0"]<-"T0"
O2_PAR_DW<-inner_join(O2_data_estimate,O2_PAR_DW_test,by=c("grp","week","ID","mesocosm","species"))
rm(O2_PAR_DW_test)
O2_PAR_DW<-O2_PAR_DW[!O2_PAR_DW$estimate>0.06,]

ggplot(O2_PAR_DW,aes(estimate,PAR))+
  geom_point(aes(color=week))+
  geom_line(aes(group=grp))+
  theme_fira()+
  theme(axis.title = element_text(size = rel(1.5), face = "bold"),
        axis.text = element_text(size = rel(1.5)),
        legend.title = element_text(size = rel(1.5), face = "bold"))#+
    #facet_wrap(~mesocosm)

O2_PAR_DW <- O2_PAR_DW[!is.infinite(O2_PAR_DW$estimate),] #remove inf values
O2_PAR_DW <- O2_PAR_DW[!is.na(O2_PAR_DW$estimate),] # remove NA

O2_PAR_DW<-O2_PAR_DW[!O2_PAR_DW$estimate>0.06,]

O2_lm <- lm(estimate ~ PAR,data=O2_PAR_DW)
plot(estimate ~ PAR,data=O2_PAR_DW)
abline(O2_lm)
summary(O2_lm)
legend("topleft",legend=paste("R2 is", format(summary(O2_lm)$r.squared,digits=3))) #R2 = 0.66
# equation : log(y)=4.2797 + (-1.5663)*log(total_lenght) + 1.024
# normality of standardized model residuals
length_lm_std <- residuals(O2_lm, type="pearson")
shapiro.test(length_lm_std) #p-value = 0.089, normality verified
qqnorm(length_lm_std)
qqline(length_lm_std)
hist(length_lm_std, xlab="standardized residuals")

library(car)

#O2_PAR_DW$Normalized_growth_rate<-10^(4.2797 + (-1.5663)*Growth_normalized$lg_total_lenght + 1.024)

#O2_PAR_DW$residuals<-O2_lm$residuals

#O2_PAR_DW$treatment<-"C"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="C1M0"]<-"HT"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="C1M1"]<-"HT"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="C1M2"]<-"HT"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="C2M0"]<-"1MH"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="C2M1"]<-"1MH"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="C2M2"]<-"1MH"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="C3M0"]<-"2MH"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="C3M1"]<-"2MH"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="C3M2"]<-"2MH"
#O2_PAR_DW$treatment[O2_PAR_DW$mesocosm=="T0"]<-"T0"
#O2_PAR_DW$treatment <- fct_relevel(O2_PAR_DW$treatment, c("T0","C","HT","1MH","2MH"))

#O2_PAR_DW$grp<-paste(O2_PAR_DW$species,"_",O2_PAR_DW$treatment,"_",O2_PAR_DW$date)

#O2_PAR_DW$date_modified<-0 # T0

#2022-07-05, J3, 0.75
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="2022-07-05"&O2_PAR_DW$treatment=="IncreasTemp"]<-0.75

#2022-07-10, J8, 2
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="2022-07-10"&O2_PAR_DW$treatment=="1MH"]<-1.94
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="2022-07-10"&O2_PAR_DW$treatment=="2MH"]<-2.07

#2022-07-12, J10, 2.5
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="2022-07-12"&O2_PAR_DW$treatment=="C"]<-2.5

#2022-07-14, J12, 3
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="2022-07-14"&O2_PAR_DW$treatment=="HT"]<-2.94
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="2022-07-14"&O2_PAR_DW$treatment=="2MH"]<-3.07

#2022-07-18, J16, 4
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="2022-07-18"&O2_PAR_DW$treatment=="1MH"]<-3.94
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="2022-07-18"&O2_PAR_DW$treatment=="2MH"]<-4.07

#2022-07-21 & 22, TF, 5
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="TF"&O2_PAR_DW$treatment=="C"]<-4.87
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="TF"&O2_PAR_DW$treatment=="HT"]<-4.93
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="TF"&O2_PAR_DW$treatment=="1MH"]<-5.07
#O2_PAR_DW$date_modified[O2_PAR_DW$week=="TF"&O2_PAR_DW$treatment=="2MH"]<-5.125

#ggplot(O2_PAR_DW,aes(y=residuals,x=date_modified,color=treatment))+
 # geom_jitter(shape = 16,size=3,alpha=0.8)+
#  geom_boxplot(aes(x=date_modified,group=grp,fill=treatment),color="black",outlier.alpha = 0)+
#  facet_wrap(species~.,ncol=1)+
#  scale_fill_manual(values=c("lightgrey","#404040","#92c5de","#E48121","#FC1D28","#901C21"))+
#  scale_color_manual(values=c("lightgrey","#404040","#92c5de","#E48121","#FC1D28","#901C21"))+
#  stat_summary(aes(y=0.001,x=date_modified),colour="black",data=O2,fun.data = give.n, geom = "text",size=8)+
#  theme_fira()+
#  scale_x_continuous(label=c("07-02","07-05","07-10","07-12","07-14","07-18","07-21 & 22"),breaks=c(0,0.75,2,2.5,3,4,5))+
#  scale_y_continuous(limits=c(-0.015,0.015),breaks=c(-0.01,0.0,0.01),expand = expansion(mult = c(0,0)))+
#  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
#        axis.text = element_text(size = rel(2)),
#        strip.text.x = element_text(size = rel(2)),
#        panel.border = element_rect(colour = "black", fill=NA),
#        legend.position="none")+
#   ylab(bquote(F[v]/F[m]))+
#  labs(x="time")

# PI curves show the effect of light on the estimate
# Therefore : let's divide the estimate by the mean PAR
O2_PAR_DW$estimate_normalized<-O2_PAR_DW$estimate/O2_PAR_DW$PAR

O2_PAR_DW$estimate_normalized[O2_PAR_DW$PAR<=0]<-0

O2_PAR_DW$variance<-O2_PAR_DW$std.error^2
O2_PAR_DW$variance<-O2_PAR_DW$variance/O2_PAR_DW$PAR
O2_PAR_DW$std_normalized<-sqrt(O2_PAR_DW$variance)

O2_PAR_DW$std_normalized[O2_PAR_DW$PAR<=0]<-0


O2<-O2_PAR_DW

# Divide O2 by the dry weight (*0.001 to convert it in kg) and multiply it by the volume of the chamber (V=30L)
# Rq : To do so, we separate the dataframe per weeks to avoid mixing data (which happens without doing this)
# Rq 2 : the std of the LM follow the same calculation

# Big chamber -> 1m height -> 29.6 L 
# Small chamber -> 80cm height -> 23.6 L 

O2$volume<-29.6
O2$volume[O2$Chamber=="Small"]<- 23.6


T0 <- O2[O2$week=="T0",]
T0$O2_normalized<-T0$estimate*T0$volume*60/T0$Dry_weight
T0$variance<-T0$std.error^2
T0$variance<-T0$variance*T0$volume*60/T0$Dry_weight
T0$std_normalized<-sqrt(T0$variance)

Week1b <- O2[O2$week=="2022-07-05",]
Week1b$O2_normalized<-Week1b$estimate*Week1b$volume*60/Week1b$Dry_weight
Week1b$variance<-Week1b$std.error^2
Week1b$variance<-Week1b$variance*Week1b$volume*60/Week1b$Dry_weight
Week1b$std_normalized<-sqrt(Week1b$variance)

Week1 <- O2[O2$week=="2022-07-10",]
Week1$O2_normalized<-Week1$estimate*Week1$volume*60/Week1$Dry_weight
Week1$variance<-Week1$std.error^2
Week1$variance<-Week1$variance*Week1$volume*60/Week1$Dry_weight
Week1$std_normalized<-sqrt(Week1$variance)

Week2 <- O2[O2$week=="2022-07-12",]
Week2$O2_normalized<-Week2$estimate*Week2$volume*60/Week2$Dry_weight
Week2$variance<-Week2$std.error^2
Week2$variance<-Week2$variance*Week2$volume*60/Week2$Dry_weight
Week2$std_normalized<-sqrt(Week2$variance)

Week3 <- O2[O2$week=="2022-07-14",]
Week3$O2_normalized<-Week3$estimate*Week3$volume*60/Week3$Dry_weight
Week3$variance<-Week3$std.error^2
Week3$variance<-Week3$variance*Week3$volume*60/Week3$Dry_weight
Week3$std_normalized<-sqrt(Week3$variance)

Week4 <- O2[O2$week=="2022-07-18",]
Week4$O2_normalized<-Week4$estimate*Week4$volume*60/Week4$Dry_weight
Week4$variance<-Week4$std.error^2
Week4$variance<-Week4$variance*Week4$volume*60/Week4$Dry_weight
Week4$std_normalized<-sqrt(Week4$variance)

TF <- O2[O2$week=="TF",]
TF$O2_normalized<-TF$estimate*TF$volume*60/TF$Dry_weight
TF$variance<-TF$std.error^2
TF$variance<-TF$variance*TF$volume*60/TF$Dry_weight
TF$std_normalized<-sqrt(TF$variance)

O2<-rbind(T0, Week1,Week1b, Week2, Week3, Week4, TF)
rm(T0, Week1, Week1b,Week2, Week3, Week4, TF)

# For a PAR = 150
O2$O2_normalized<-O2$O2_normalized*150

# Define the order of apparition the x axis
O2$treatment<-"C"
O2$treatment[O2$mesocosm=="C1M0"]<-"HT"
O2$treatment[O2$mesocosm=="C1M1"]<-"HT"
O2$treatment[O2$mesocosm=="C1M2"]<-"HT"
O2$treatment[O2$mesocosm=="C2M0"]<-"1MH"
O2$treatment[O2$mesocosm=="C2M1"]<-"1MH"
O2$treatment[O2$mesocosm=="C2M2"]<-"1MH"
O2$treatment[O2$mesocosm=="C3M0"]<-"2MH"
O2$treatment[O2$mesocosm=="C3M1"]<-"2MH"
O2$treatment[O2$mesocosm=="C3M2"]<-"2MH"
O2$treatment[O2$mesocosm=="T0"]<-"T0"
#O2$condition <- fct_relevel(O2$treatment, c("T0","C","HT","1MH","2MH"))

# Divide the dataframe in 2 (1 for each species)
#Alaria<-O2[O2$species=="Alaria",]
#Saccharina<-O2[O2$species=="Saccharina",]

# For each new data frame: duplicate the rows corresponding to T0 incubation into incorporate the T0 values in each facet (cf- ggplot below)
# Alaria
#Alaria_w2<-Alaria[rep(c(1:6),),]
#Alaria_w2$Graph<-"2022-07-10"

#Alaria_w2b<-Alaria[rep(c(1:6),),]
#Alaria_w2b$Graph<-"2022-07-05"

#Alaria_w5<-Alaria[rep(c(1:6),),]
#Alaria_w5$Graph<-"2022-07-12"

#Alaria_w6<-Alaria[rep(c(1:6),),]
#Alaria_w6$Graph<-"2022-07-14"

#Alaria_w7<-Alaria[rep(c(1:6),),]
#Alaria_w7$Graph<-"2022-07-14"

#Alaria_TF<-Alaria[rep(c(1:6),),]
#Alaria_TF$Graph<-"TF"

#Alaria<-Alaria[Alaria$week!="T0",]
#Alaria$Graph<-Alaria$week

#Alaria<-rbind(Alaria,Alaria_w2,Alaria_w2b,Alaria_w5,Alaria_w6,Alaria_w7,Alaria_TF)
#rm(Alaria_w2,Alaria_w5,Alaria_TF)


# Saccharina
#Saccharina_w2<-Saccharina[rep(c(1:6),),]
#Saccharina_w2$Graph<-"2022-07-10"

#Saccharina_w2b<-Saccharina[rep(c(1:6),),]
#Saccharina_w2b$Graph<-"2022-07-05"

#Saccharina_w5<-Saccharina[rep(c(1:6),),]
#Saccharina_w5$Graph<-"2022-07-12"

#Saccharina_w6<-Saccharina[rep(c(1:6),),]
#Saccharina_w6$Graph<-"2022-07-14"

#Saccharina_w7<-Saccharina[rep(c(1:6),),]
#Saccharina_w7$Graph<-"2022-07-14"

#Saccharina_TF<-Saccharina[rep(c(1:6),),]
#Saccharina_TF$Graph<-"TF"

#Saccharina<-Saccharina[Saccharina$week!="T0",]
#Saccharina$Graph<-Saccharina$week

#Saccharina<-rbind(Saccharina,Saccharina_w2,Saccharina_w2b,Saccharina_w5,Saccharina_w6,Saccharina_w7,Saccharina_TF)
#rm(Saccharina_w2,Saccharina_w5,Saccharina_TF)

# Create a condition_week column
#Alaria$condition_week<-paste(Alaria$condition,Alaria$week,sep="_")
#Saccharina$condition_week<-paste(Saccharina$condition,Saccharina$week,sep="_")

#O2<-rbind(Alaria,Saccharina)

# Define the order of apparition on the facet
O2$treatment[O2$week=="2022-07-05"]<-"IncreasTemp"
O2$treatment <- fct_relevel(O2$treatment, c("T0","IncreasTemp","C","HT","1MH","2MH"))

give.n <- function(x){
   return(c(y = mean(x), label = length(x)))
}
# Plot ####

ggplot(O2,aes(y=O2_normalized,x=date,colour=treatment))+
  #geom_jitter(size=3)+ 
  geom_errorbar(aes(ymin=O2_normalized-std_normalized, ymax=O2_normalized+std_normalized), width=.2,position=position_dodge(0.05))+
  scale_colour_manual(values=c("#cccccc","#92c5de","#0571b0","#f4a582","#ca0020"))+
  ylab(bquote('µmol O2'(min^-1,FW^-1)))+
  xlab(bquote('conditions'))+
  facet_wrap(~species)+
  theme_fira()

O2$date_modified<-0 # T0

#2022-07-05, J3, 0.75
O2$date_modified[O2$week=="2022-07-05"&O2$treatment=="IncreasTemp"]<-0.75

#2022-07-10, J8, 2
O2$date_modified[O2$week=="2022-07-10"&O2$treatment=="1MH"]<-1.94
O2$date_modified[O2$week=="2022-07-10"&O2$treatment=="2MH"]<-2.07

#2022-07-12, J10, 2.5
O2$date_modified[O2$week=="2022-07-12"&O2$treatment=="C"]<-2.5

#2022-07-14, J12, 3
O2$date_modified[O2$week=="2022-07-14"&O2$treatment=="HT"]<-2.94
O2$date_modified[O2$week=="2022-07-14"&O2$treatment=="2MH"]<-3.07

#2022-07-18, J16, 4
O2$date_modified[O2$week=="2022-07-18"&O2$treatment=="1MH"]<-3.94
O2$date_modified[O2$week=="2022-07-18"&O2$treatment=="2MH"]<-4.07

#2022-07-21 & 22, TF, 5
O2$date_modified[O2$week=="TF"&O2$treatment=="C"]<-4.87
O2$date_modified[O2$week=="TF"&O2$treatment=="HT"]<-4.93
O2$date_modified[O2$week=="TF"&O2$treatment=="1MH"]<-5.07
O2$date_modified[O2$week=="TF"&O2$treatment=="2MH"]<-5.125

O2$date_modified<-as.numeric(O2$date_modified)
O2$grp<-paste(O2$species,"_",O2$treatment,"_",O2$date)

ggplot(O2,aes(y=O2_normalized,x=date_modified,color=treatment))+
  geom_jitter(shape = 16,size=3,alpha=0.8)+
  geom_boxplot(aes(group=grp,fill=treatment),color="black",outlier.alpha = 0)+
  facet_wrap(species~.,ncol=1)+
  scale_fill_manual(values=c("lightgrey","#404040","#92c5de","#E48121","#FC1D28","#901C21"))+
  scale_color_manual(values=c("lightgrey","#404040","#92c5de","#E48121","#FC1D28","#901C21"))+
  stat_summary(aes(y=275,x=date_modified),colour="black",data=O2,fun.data = give.n, geom = "text",size=8)+
  theme_fira()+
  scale_x_continuous(label=c("07-02","07-05","07-10","07-12","07-14","07-18","07-21 & 22"),breaks=c(0,0.75,2,2.5,3,4,5))+
  scale_y_continuous(limits=c(0,330),breaks=c(0,50,100,150,200,250,300),expand = expansion(mult = c(0,0)))+
  theme(axis.title = element_text(size = rel(1.5), hjust=0.5),
        axis.text = element_text(size = rel(2)),
        strip.text.x = element_text(size = rel(2)),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.position="right")+
  labs(y="photosynthetic rate",x="time")

# Remove outliers
library(EnvStats)
library(ggpubr)
# the parameter k defines the number of potential outlier in a dataset, the default k value is 3
O2_Alaria<-O2[O2$species=="Alaria",]

O2_Alaria_T0<-O2_Alaria[O2_Alaria$week=="T0",]
rosnerTest(O2_Alaria_T0$O2_normalized, k = 1)$all.stats # no outlier
shapiro.test(O2_Alaria_T0$O2_normalized) # Normal (pvalue>0.05)
ggqqplot(O2_Alaria_T0$O2_normalized)

O2_Alaria_10<-O2_Alaria[O2_Alaria$week=="2022-07-10",]
rosnerTest(O2_Alaria_10$O2_normalized, k = 2)$all.stats # NO OUTLIER
shapiro.test(O2_Alaria_10$O2_normalized)
ggqqplot(O2_Alaria_10$O2_normalized)

O2_Alaria_10_1MH<-O2_Alaria_10[O2_Alaria_10$treatment=="1MH",]
rosnerTest(O2_Alaria_10_1MH$O2_normalized, k = 1)$all.stats

O2_Alaria_10_2MH<-O2_Alaria_10[O2_Alaria_10$treatment=="2MH",]
rosnerTest(O2_Alaria_10_2MH$O2_normalized, k = 1)$all.stats

O2_Alaria_TF<-O2_Alaria[O2_Alaria$week=="TF",]
O2_Alaria_TF_2MH<-O2_Alaria_TF[O2_Alaria_TF$treatment=="2MH",]
rosnerTest(O2_Alaria_TF_2MH$O2_normalized, k = 1)$all.stats
shapiro.test(O2_Alaria_TF_2MH$O2_normalized)# Normal (pvalue>0.05)
ggqqplot(O2_Alaria_TF_2MH$O2_normalized)

# SACCHARINA
O2_Saccharina<-O2[O2$species=="Saccharina",]

O2_Saccharina_T0<-O2_Saccharina[O2_Saccharina$week=="T0",]
rosnerTest(O2_Saccharina_T0$O2_normalized, k = 1)$all.stats # 1 outlier : 704.4594

O2_Saccharina_05<-O2_Saccharina[O2_Saccharina$week=="2022-07-05",]
rosnerTest(O2_Saccharina_05$O2_normalized, k = 2)$all.stats # 2 outliers
O2<-O2[!(O2$O2_normalized>=250&O2$week=="2022-07-05"),]
O2_Saccharina<-O2[O2$species=="Saccharina",]
O2_Saccharina_05<-O2_Saccharina[O2_Saccharina$week=="2022-07-05",]
shapiro.test(O2_Saccharina_05$O2_normalized)# Normal (pvalue>0.05)
ggqqplot(O2_Saccharina_05$O2_normalized)

O2_Saccharina_10<-O2_Saccharina[O2_Saccharina$week=="2022-07-10",]
rosnerTest(O2_Saccharina_10$O2_normalized, k = 1)$all.stats # no outlier

O2_Saccharina_10_1MH<-O2_Saccharina_10[O2_Saccharina_10$treatment=="1MH",]
rosnerTest(O2_Saccharina_10_1MH$O2_normalized, k = 1)$all.stats
O2_Saccharina_10_2MH<-O2_Saccharina_10[O2_Saccharina_10$treatment=="2MH",]
rosnerTest(O2_Saccharina_10_2MH$O2_normalized, k = 1)$all.stats

O2_Saccharina_18<-O2_Saccharina[O2_Saccharina$week=="2022-07-18",]
rosnerTest(O2_Saccharina_18$O2_normalized, k = 1)$all.stats # no outlier

O2_Saccharina_18_1MH<-O2_Saccharina_18[O2_Saccharina_18$treatment=="1MH",]
rosnerTest(O2_Saccharina_18_1MH$O2_normalized, k = 1)$all.stats # no outlier

O2_Saccharina_18_2MH<-O2_Saccharina_18[O2_Saccharina_18$treatment=="2MH",]
rosnerTest(O2_Saccharina_18_2MH$O2_normalized, k = 1)$all.stats # no outlier

# Rbind
#O2<-rbind()
rm(O2_Alaria,O2_Alaria_T0,O2_Alaria_10,O2_Alaria_10_1MH,O2_Alaria_10_2MH)

# Statistics ####
# We want to compare each measurements of O2 synthesis mean between : conditions, replicates, species, weeks
# To do so we can use a linear mixed-effects model
# We can test 2 different models :
# HLM (lmer) or GLM

O2_Alaria<-O2[O2$species=="Alaria",]
O2_glm<-glm(O2_normalized ~ week*treatment, data=O2_Alaria)
Anova(O2_glm)
emmeans(O2_glm, list(pairwise ~ week*treatment), adjust = "tukey")


# significative differences:
#                                                     estimate   SE df t.ratio p.value
# (2022-07-10 1MH) - TF 2MH                              85.10 20.3 66   4.196  0.0380
# TF HT - (2022-07-10 1MH)                              -97.14 20.3 66  -4.789  0.0058
# (2022-07-14 HT) - (2022-07-10 1MH)                    -92.51 20.3 66  -4.561  0.0123
# TF C - (2022-07-10 1MH)                               -93.96 20.3 66  -4.632  0.0097

# (2022-07-10 1MH) - TF 1MH                              90.69 20.3 66   4.471  0.0163

# (2022-07-05 IncreasTemp) - TF 2MH                      83.45 18.1 66   4.613  0.0104
# (2022-07-05 IncreasTemp) - TF 1MH                      89.05 18.1 66   4.923  0.0037
# (2022-07-05 IncreasTemp) - TF HT                       95.50 18.1 66   5.279  0.0010
# (2022-07-05 IncreasTemp) - TF C                        92.31 18.1 66   5.103  0.0019

# (2022-07-05 IncreasTemp) - (2022-07-14 HT)             90.87 18.1 66   5.023  0.0026

# T0 T0 - (2022-07-14 2MH)                               72.63 18.1 66   4.015  0.0637
# T0 T0 - (2022-07-14 HT)                               106.79 18.1 66   5.903  0.0001

# T0 T0 - TF 1MH                                        104.97 18.1 66   5.803  0.0001
# T0 T0 - TF 2MH                                         99.37 18.1 66   5.493  0.0005
# T0 T0 - TF HT                                         111.42 18.1 66   6.159  <.0001
# T0 T0 - TF C                                          108.23 18.1 66   5.983  0.0001

O2_Saccharina<-O2[O2$species=="Saccharina",]
O2_glm<-glm(O2_normalized ~ week*treatment, data=O2_Saccharina)
Anova(O2_glm)
emmeans(O2_glm, list(pairwise ~ week*treatment), adjust = "tukey")
#                                                     estimate   SE df t.ratio p.value
#T0 T0 - (2022-07-14 HT)                               189.77 45.2 58   4.196  0.0412

```
